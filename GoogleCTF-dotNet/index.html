<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="Google CTF 2020 [.Net-RE]">
<meta property="og:url" content="https://mrt4ntr4.github.io/GoogleCTF-dotNet/index.html">
<meta property="og:site_name" content="mrT4ntr4&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/thumb.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/sample_run.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/entrypoint.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/main.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/launchgui.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/kvot.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/submit.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/main_check1.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/enc_char.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/decodebase64bytewise.PNG">
<meta property="og:image" content="https://media.giphy.com/media/oOTTyHRHj0HYY/giphy.gif">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/main_check2.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/list_xor.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/checksum.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/vaxmyra.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/final_conds.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/nuffra.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/calli.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/is_debugger_attached.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/harmony_caller.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/debugger_check1.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/patched_fcns.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/harmony_logic.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/native_fcns.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/rebase.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/debugger_check2.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/native1.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/native_to_cs.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/storage_stream.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/ida_script_res.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/net51.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/char_encode.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/native1_renamed.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/native2.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/xor_arr_data.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/xor_arr_init.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/xor_native_fcn.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/random_shuffle_net.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/rand_shuffle_debug.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/rand_shuffle_func_renamed.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/googlectf/native2_renamed.PNG">
<meta property="og:image" content="https://media.giphy.com/media/gg2z3LuDDvOVaKVVd3/giphy-downsized.gif">
<meta property="og:image" content="https://media.giphy.com/media/1zijfEWLg9bIuAXna7/giphy.gif">
<meta property="article:published_time" content="2020-08-25T22:00:00.000Z">
<meta property="article:modified_time" content="2021-01-20T07:55:09.171Z">
<meta property="article:author" content="Suraj Malhotra">
<meta property="article:tag" content="writeup">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="reversing">
<meta property="article:tag" content="google">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mrt4ntr4.github.io/img/googlectf/thumb.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
        
      
    
    <!-- title -->
    <title>Google CTF 2020 [.Net-RE]</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/feed.xml" title="mrT4ntr4&#39;s Blog" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.3.0"></head>

<div class="background">
    <div class="banner">
<div id="blogtitle" class="blogtitle">mrT4ntr4&#39;s Blog</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/JustCTF-debugme/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/Noverify-Java-Crackme-3/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://mrt4ntr4.github.io/GoogleCTF-dotNet/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&text=Google CTF 2020 [.Net-RE]"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&is_video=false&description=Google CTF 2020 [.Net-RE]"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Google CTF 2020 [.Net-RE]&body=Check out this article: https://mrt4ntr4.github.io/GoogleCTF-dotNet/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&name=Google CTF 2020 [.Net-RE]&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&t=Google CTF 2020 [.Net-RE]"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Challenge"><span class="toc-number">1.</span> <span class="toc-text">Challenge</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TL-DR"><span class="toc-number">2.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">3.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Static-Analysis"><span class="toc-number">4.</span> <span class="toc-text">Static Analysis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dynamic-Analysis"><span class="toc-number">5.</span> <span class="toc-text">Dynamic Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Harmony-Magic"><span class="toc-number">5.1.</span> <span class="toc-text">Harmony Magic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Harmony-works"><span class="toc-number">5.1.1.</span> <span class="toc-text">How Harmony works</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysing-Native-Functions-with-IDAPython"><span class="toc-number">5.2.</span> <span class="toc-text">Analysing Native Functions with IDAPython</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Z3-amp-Profit"><span class="toc-number">6.</span> <span class="toc-text">Z3 &amp; Profit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Solution-Files"><span class="toc-number">7.</span> <span class="toc-text">Solution Files</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Google CTF 2020 [.Net-RE]
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Suraj Malhotra</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-08-25T22:00:00.000Z" itemprop="datePublished">2020-08-26</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF-Writeups/">CTF Writeups</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/ctf/" rel="tag">ctf</a>, <a class="tag-link-link" href="/tags/google/" rel="tag">google</a>, <a class="tag-link-link" href="/tags/reversing/" rel="tag">reversing</a>, <a class="tag-link-link" href="/tags/writeup/" rel="tag">writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p><a href="/img/googlectf/thumb.png" title="banner" class="gallery-item"><img src="/img/googlectf/thumb.png" alt="banner"></a></p>
<p>I got to know that Google CTF had some interesting rev challs. I was late for it so I didn’t participate in the event with a team and also we aren’t quite active these days.<br>I picked up 2nd least solved reversing challenge ie. .Net. Its an interesting challenge and I learnt a lot from it as well, so it might be a little longer than usual but its worth it in the end.  </p>
<hr>
<h1 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h1><blockquote>
<p>.Net is great, especially because of all its weird features.<br><strong>Download :</strong>   <a href="/files/googlectf/chall.zip"  target="_blank">chall.zip</a>  </p>
</blockquote>
<hr>
<h1 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h1><ul>
<li><strong>Dynamic Instrumentation using HarmonyLib</strong></li>
<li><strong>C# &lt;=&gt; Native asm FFI</strong></li>
<li><strong>IDAPython Scripting to assist in native functions analysis</strong></li>
<li><strong>Replicate algo in python and then finding a valid solution for it using z3</strong></li>
</ul>
<hr>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>The challenge includes two files ie. <code>0Harmony.dll</code> and <code>EKTORPFlagValidator.exe</code>.<br>So the name looks a bit weird. I just googled them and found that <a target="_blank" rel="noopener" href="https://github.com/pardeike/Harmony">Harmony</a> is actually a libary for doing some runtime patching stuff in .Net apps.  </p>
<p>With the help of a sample run, we see that it requires a string of length = 30 and also that it validates a checksum from our input.  </p>
<p><a href="/img/googlectf/sample_run.PNG" title="sample_run" class="gallery-item"><img src="/img/googlectf/sample_run.PNG" alt="sample_run"></a>  </p>
<hr>
<h1 id="Static-Analysis"><a href="#Static-Analysis" class="headerlink" title="Static Analysis"></a>Static Analysis</h1><p>So lets start at the entrypoint. And yeah at first I tried to analyse the constructor too but it looked kinda hard to understand statically and I left it for debugging at last.  </p>
<p><a href="/img/googlectf/entrypoint.PNG" title="entrypoint" class="gallery-item"><img src="/img/googlectf/entrypoint.PNG" alt="entrypoint"></a>  </p>
<p>So there is this main method which later calls LaunchGui() and as a result we are now in KVOT class.  </p>
<p><a href="/img/googlectf/main.PNG"><a href="/img/googlectf/main.PNG" title="main" class="gallery-item"><img src="/img/googlectf/main.PNG" alt="main"></a></a>  </p>
<p><a href="/img/googlectf/launchgui.PNG"><a href="/img/googlectf/launchgui.PNG" title="launchgui" class="gallery-item"><img src="/img/googlectf/launchgui.PNG" alt="launchgui"></a></a>  </p>
<p>Now we are inside KVOT and it looks like method names are weird.  </p>
<p><a href="/img/googlectf/kvot.PNG"><a href="/img/googlectf/kvot.PNG" title="kvot" class="gallery-item"><img src="/img/googlectf/kvot.PNG" alt="kvot"></a></a>  </p>
<p>After the basic initialization part for the GUI there is an event handler <code>submit_button_Click()</code> which looks exactly how we want it to be.  </p>
<p><a href="/img/googlectf/submit.PNG"><a href="/img/googlectf/submit.PNG" title="submit" class="gallery-item"><img src="/img/googlectf/submit.PNG" alt="submit"></a></a>  </p>
<p>Ahmmm It does the string length check here, and if it succeeds then call another method with our input string as an argument to <code>SOCKERBIT.GRUNDTAL_NORRVIKEN</code> which returns a list.<br>Also after that it does a basic check that the elements of the returned list are all less than 63 which looks like a character range check from the failure string.  </p>
<p><a href="/img/googlectf/main_check1.PNG"><a href="/img/googlectf/main_check1.PNG" title="main_check1" class="gallery-item"><img src="/img/googlectf/main_check1.PNG" alt="main_check1"></a></a>  </p>
<p>And yeah, There is more to it, just hold up.<br><code>GRUNDTAL_NORRVIKEN</code> then calls <code>DecodeBase64Bytewise</code> on each of the element of our string.  </p>
<p><a href="/img/googlectf/enc_char.PNG"><a href="/img/googlectf/enc_char.PNG" title="enc_char" class="gallery-item"><img src="/img/googlectf/enc_char.PNG" alt="enc_char"></a></a>  </p>
<p>Hmm, now it gets weird… the <code>DecodeBase64Bytewise</code> method looks like it is trying to instead encode our input and also it checks some conditions which would never return true except the <code>123(&#39;&#123;&#39;)</code> and <code>125(&#39;&#125;&#39;)</code> check.  </p>
<p><a href="/img/googlectf/decodebase64bytewise.PNG"><a href="/img/googlectf/decodebase64bytewise.PNG" title="decodebase64bytewise" class="gallery-item"><img src="/img/googlectf/decodebase64bytewise.PNG" alt="decodebase64bytewise"></a></a>  </p>
<p>That means if we input some lowercase characters which should be valid, then it’ll just return a list of 30 -1’s. </p>
<a target="_blank" rel="noopener" href="https://media.giphy.com/media/oOTTyHRHj0HYY/giphy.gif" title="drawing" class="gallery-item"><img src="https://media.giphy.com/media/oOTTyHRHj0HYY/giphy.gif" alt="drawing" width="300"/></a>  

<p>But the signness trick here casts it to an unsigned integer.<br>Something like this :  </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((uint)(<span class="built_in">byte</span>)(arg + <span class="number">191</span>) &lt;= <span class="number">25u</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Console.WriteLine((uint)(<span class="built_in">byte</span>)(arg + <span class="number">191</span>));  <span class="comment">// overflows  </span></span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">sbyte</span>)(arg - <span class="number">55</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For eg. ‘H’(72) fulfills the above condition since <code>(byte)(72+191)</code> is 7 when cast to a byte and not 263.  </p>
<p>This is the 2nd part of the check routine with methods <code>DAGSTORP</code>, <code>SMORBOLL</code> and <code>HEROISK</code>.<br>A list is initialized and passed to <code>DAGSTORP</code> along with our encrypted input.  </p>
<p><a href="/img/googlectf/main_check2.PNG"><a href="/img/googlectf/main_check2.PNG" title="main_check2" class="gallery-item"><img src="/img/googlectf/main_check2.PNG" alt="main_check2"></a></a>  </p>
<p>Ahh, It just looks like a simple xor, ezpz!</p>
<p><a href="/img/googlectf/list_xor.PNG"><a href="/img/googlectf/list_xor.PNG" title="list_xor" class="gallery-item"><img src="/img/googlectf/list_xor.PNG" alt="list_xor"></a></a>  </p>
<p>Then there is this checksum as you’ve guessed it from the failure string. It calculates the checksum on the basis that it does different calculations according to the index value.<br>The index value checks are just for checking whether the index is divisible by 2,3,5 or 7 and FYI, it doesn’t include the index 28 as it is later compared with the final checksum value.  </p>
<p><a href="/img/googlectf/checksum.PNG"><a href="/img/googlectf/checksum.PNG" title="checksum" class="gallery-item"><img src="/img/googlectf/checksum.PNG" alt="checksum"></a></a>  </p>
<p>And then there is method <code>VAXMYRA</code> which just checks if there are any duplicates in the encrypted array.  </p>
<p><a href="/img/googlectf/vaxmyra.PNG"><a href="/img/googlectf/vaxmyra.PNG" title="vaxmyra" class="gallery-item"><img src="/img/googlectf/vaxmyra.PNG" alt="vaxmyra"></a></a>  </p>
<p>And after bypassing through the checksum validation and <code>VAXMYRA</code> we get to the main condition checks that validates our encrypted input. And Yes, I smell z3!  </p>
<p><a href="/img/googlectf/final_conds.PNG"><a href="/img/googlectf/final_conds.PNG" title="final_conds" class="gallery-item"><img src="/img/googlectf/final_conds.PNG" alt="final_conds"></a></a>  </p>
<hr>
<h1 id="Dynamic-Analysis"><a href="#Dynamic-Analysis" class="headerlink" title="Dynamic Analysis"></a>Dynamic Analysis</h1><p>Getting to the main fun part ie. debugging it in dnsPy.<br>Huh wait a sec where is FYRKANTIG. Instead we get redirected to NUFFRA and now it looks more complicated and gibberish to deal with.</p>
<p><a href="/img/googlectf/nuffra.PNG"><a href="/img/googlectf/nuffra.PNG" title="nuffra" class="gallery-item"><img src="/img/googlectf/nuffra.PNG" alt="nuffra"></a></a>  </p>
<p>So to explain this inner magic and so called weirdness we’ll have to debug right from the constructor. If you’d traced the execution accurately, you’ll find that there is a <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.calli?view=netcore-3.1">calli</a> instruction which calls a method by specifying its address as an argument.  </p>
<p><a href="/img/googlectf/calli.PNG"><a href="/img/googlectf/calli.PNG" title="calli" class="gallery-item"><img src="/img/googlectf/calli.PNG" alt="calli"></a></a>  </p>
<p>I noticed that it calls several functions and just noted down the method addresses ie. from <code>num</code> variable.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x600003B</span>   <span class="comment"># Debugger.IsAttached() check (native)</span></span><br><span class="line"><span class="number">0x600003D</span></span><br><span class="line"><span class="number">0x6000046</span>   <span class="comment"># patch functions routine (native)</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x60000D6</span></span><br><span class="line"><span class="number">0x60000D7</span></span><br><span class="line"><span class="number">0x60000D8</span></span><br><span class="line"><span class="number">0x60000D9</span>   <span class="comment"># we don&#x27;t care about the 0xD6-0xDC functions</span></span><br><span class="line"><span class="number">0x60000DA</span></span><br><span class="line"><span class="number">0x60000DB</span></span><br><span class="line"><span class="number">0x60000DC</span></span><br></pre></td></tr></table></figure>
<p>0x600003B has a simple anti-debug check with <code>System.Diagnostics.Debugger.IsAttached</code>!  </p>
<p><a href="/img/googlectf/is_debugger_attached.PNG"><a href="/img/googlectf/is_debugger_attached.PNG" title="is_debugger_attached" class="gallery-item"><img src="/img/googlectf/is_debugger_attached.PNG" alt="is_debugger_attached"></a></a>  </p>
<p>0x6000046 is the magic method here which in turn calls another native function.  </p>
<p><a href="/img/googlectf/harmony_caller.PNG"><a href="/img/googlectf/harmony_caller.PNG" title="harmony_caller" class="gallery-item"><img src="/img/googlectf/harmony_caller.PNG" alt="harmony_caller"></a></a>  </p>
<p>That native function has another anti-debug technique implemented ie <code>kernel32.dll::IsDebuggerPresent</code> and if it is true it returns 1 which eventually doesn’t do anything and the latter will call a c# method which is indeed responsible for changing the methods.  </p>
<p><a href="/img/googlectf/debugger_check1.PNG"><a href="/img/googlectf/debugger_check1.PNG" title="debugger_check1" class="gallery-item"><img src="/img/googlectf/debugger_check1.PNG" alt="debugger_check1"></a></a>  </p>
<p>And Fortunately it happens that dnsPy has got us covered and was successful in deafeating those anti-debug techniques like a ninja. All thanks to this <a target="_blank" rel="noopener" href="https://github.com/0xd4d/dnSpy/issues/288">issue</a>  </p>
<h2 id="Harmony-Magic"><a href="#Harmony-Magic" class="headerlink" title="Harmony Magic"></a>Harmony Magic</h2><p>So this is the function called if the isDebuggerPresent returns false and it looks like it is patching the original methods we found during the static analysis to some other methods.  </p>
<p><a href="/img/googlectf/patched_fcns.PNG"><a href="/img/googlectf/patched_fcns.PNG" title="patched_fcns" class="gallery-item"><img src="/img/googlectf/patched_fcns.PNG" alt="patched_fcns"></a></a>  </p>
<h3 id="How-Harmony-works"><a href="#How-Harmony-works" class="headerlink" title="How Harmony works"></a>How Harmony works</h3><p>Harmony <a target="_blank" rel="noopener" href="https://harmony.pardeike.net/articles/intro.html">docs</a> explains it better but basically here it just patches a method body at runtime.  </p>
<p><strong>From docs :</strong><br>Where other patch libraries simply allow you to replace the original method, Harmony goes one step further and gives you:</p>
<ul>
<li>A way to keep the original method intact</li>
<li>Execute your code before and/or after the original method</li>
<li>Modify the original with IL code processors</li>
<li>Multiple Harmony patches co-exist and don’t conflict with each other</li>
</ul>
<p><a href="/img/googlectf/harmony_logic.PNG"><a href="/img/googlectf/harmony_logic.PNG" title="harmony_logic" class="gallery-item"><img src="/img/googlectf/harmony_logic.PNG" alt="harmony_logic"></a></a>  </p>
<p>As a reference we can have this <strong>Patched Method List</strong> :</p>
<table>
<thead>
<tr>
<th>Original method</th>
<th>Patched Method</th>
</tr>
</thead>
<tbody><tr>
<td><strong>KVOT.FYRKANTIG</strong> <br>  (static fcn caller)</td>
<td><strong>GATKAMOMILL.NUFFRA</strong> <br> (native fcn caller)</td>
</tr>
<tr>
<td><strong>KVOT.RIKTIG_OGLA</strong> <br> (useless)</td>
<td><strong>GATKAMOMILL.GRONKULLA</strong> <br> (useless)</td>
</tr>
<tr>
<td><strong>SOCKERBIT.GRUNDTAL_NORRVIKEN</strong> <br> (DecodeBase64ByteWise() caller)</td>
<td><strong>GATKAMOMILL.SPARSAM</strong> <br> (str to list convertor)</td>
</tr>
<tr>
<td><strong>FARGRIK.DAGSTORP</strong> <br> (xor implementation)</td>
<td><strong>GATKAMOMILL.FLARDFULL</strong> <br> (anti-debug check [GODDAG])</td>
</tr>
</tbody></table>
<hr>
<h2 id="Analysing-Native-Functions-with-IDAPython"><a href="#Analysing-Native-Functions-with-IDAPython" class="headerlink" title="Analysing Native Functions with IDAPython"></a>Analysing Native Functions with IDAPython</h2><p>Digging Deeper we need to analyse these native functions in some dissasembler like IDA, as dnsPy fails for them. These are the three main native functions called by method <code>NUFFRA</code>. Also, note down the RVAs marked in Red, these are the references to the native functions.  </p>
<p><a href="/img/googlectf/native_fcns.PNG"><a href="/img/googlectf/native_fcns.PNG" title="native_fcns" class="gallery-item"><img src="/img/googlectf/native_fcns.PNG" alt="native_fcns"></a></a>  </p>
<p>In IDA, we should load it as a normal PE file and then define some code at different locations as IDA doesn’t recognise it very well. Here we can either rebase the program to make it try to load from 0x0 or add 0x400000 to the RVA and then analyse it.  </p>
<p><a href="/img/googlectf/rebase.PNG"><a href="/img/googlectf/rebase.PNG" title="rebase" class="gallery-item"><img src="/img/googlectf/rebase.PNG" alt="rebase"></a></a>  </p>
<ul>
<li>Func 1 [GODDAG]</li>
</ul>
<p>We can just go over that address <code>(0x00001930)</code> and defining it as code pretty much clears what is it used for. So there is a anti-debug check, and this looks like the right function as well since it returns True/False, which is then used in the C# code to progress further if False.  </p>
<p><a href="/img/googlectf/debugger_check2.PNG"><a href="/img/googlectf/debugger_check2.PNG" title="debugger_check2" class="gallery-item"><img src="/img/googlectf/debugger_check2.PNG" alt="debugger_check2"></a></a>  </p>
<ul>
<li>Func 2 [NativeGRUNDTAL_NORRVIKEN]</li>
</ul>
<p>The second important function is performing some functions on our input string elements.   </p>
<p><a href="/img/googlectf/native1.PNG"><a href="/img/googlectf/native1.PNG" title="native1" class="gallery-item"><img src="/img/googlectf/native1.PNG" alt="native1"></a></a>  </p>
<p>Now this native function is interesting as the defined functions are just dwords and If we observe these are just referencing the C# code instead.  </p>
<p><strong>This can be illustrated by the following :</strong>  </p>
<p><a href="/img/googlectf/native_to_cs.PNG"><a href="/img/googlectf/native_to_cs.PNG" title="native_to_cs" class="gallery-item"><img src="/img/googlectf/native_to_cs.PNG" alt="native_to_cs"></a></a>  </p>
<p>For automatically renaming these dwords we first we need to navigate to <strong>Storage Stream -&gt; Method</strong> to get a full list of methods.  </p>
<p><a href="/img/googlectf/storage_stream.PNG"><a href="/img/googlectf/storage_stream.PNG" title="storage_stream" class="gallery-item"><img src="/img/googlectf/storage_stream.PNG" alt="storage_stream"></a></a>  </p>
<p>We can then copy them, make a json file with token and method names as the keys and values respectively. Now we can write an IDAPython script to rename the dwords recognised by IDA with the name as ‘dword_xxxx’ accordingly.<br>TBH this idea of scripting IDA struck to me while doing this writeup lol.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rename_dwords</span>():</span></span><br><span class="line">  f = <span class="built_in">open</span>(<span class="string">&#x27;method_map.json&#x27;</span>) </span><br><span class="line">  method_map = json.load(f) </span><br><span class="line">  token_list = [<span class="built_in">int</span>(x,<span class="number">16</span>) <span class="keyword">for</span> x <span class="keyword">in</span> method_map.keys()]</span><br><span class="line"></span><br><span class="line">  data_seg_selector = idc.SegByName(<span class="string">&#x27;.data&#x27;</span>)</span><br><span class="line">  data_seg_startea = idc.SegByBase(data_seg_selector)</span><br><span class="line">  data_seg_endea = idc.SegEnd(data_seg_startea)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#maybe compability issue</span></span><br><span class="line">  SN_FORCE = <span class="number">0x800</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ea <span class="keyword">in</span> <span class="built_in">range</span>(data_seg_startea, data_seg_endea):</span><br><span class="line">    var_name = Name(ea)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;dword&#x27;</span> <span class="keyword">in</span> var_name:</span><br><span class="line">      dword_val = Dword(ea)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> dword_val <span class="keyword">in</span> token_list:</span><br><span class="line">        formatted_token = <span class="string">&quot;0x0%X&quot;</span> % dword_val</span><br><span class="line">        new_name = <span class="built_in">str</span>(method_map[formatted_token])</span><br><span class="line">        idc.set_name(ea, new_name, SN_NOCHECK | SN_FORCE)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;done renaming &quot;</span> + var_name +<span class="string">&quot; to &quot;</span> + new_name</span><br></pre></td></tr></table></figure>
<p>Ahh We get a nice and clean view of all the renamed referenced dwords as functions though I’ll not refer to this renaming fashion in this writeup since it is not the best way to make a third person understand the algo as afterall it has method names which will be long af along with their class which we don’t care about here.  </p>
<p><a href="/img/googlectf/ida_script_res.PNG"><a href="/img/googlectf/ida_script_res.PNG" title="ida_script_res" class="gallery-item"><img src="/img/googlectf/ida_script_res.PNG" alt="ida_script_res"></a></a>  </p>
<p>Continuing with the analysis of <code>NativeGRUNDTAL_NORRVIKEN</code>, we see some offset calculations and dereferencing a pointer from that offset and later returning it.  </p>
<p><a href="/img/googlectf/net51.PNG"><a href="/img/googlectf/net51.PNG" title="net51" class="gallery-item"><img src="/img/googlectf/net51.PNG" alt="net51"></a></a>  </p>
<p>Yes! This looks like the main encryption algo. This checks if the character is in the valid chars range and then encrypts it. The last two checks are similar for curly braces.  </p>
<p><a href="/img/googlectf/char_encode.PNG"><a href="/img/googlectf/char_encode.PNG" title="char_encode" class="gallery-item"><img src="/img/googlectf/char_encode.PNG" alt="char_encode"></a></a>  </p>
<p>And after some renaming, the <code>NativeGRUNDTAL_NORRVIKEN</code> function looks like the following which concludes that it is only used for encrypting the string.<br>Also FYI, it uses another list for storing the encrypted string as there is <code>another get_element_from_index</code> func.  </p>
<p><a href="/img/googlectf/native1_renamed.PNG"><a href="/img/googlectf/native1_renamed.PNG" title="native1_renamed" class="gallery-item"><img src="/img/googlectf/native1_renamed.PNG" alt="native1_renamed"></a></a>  </p>
<ul>
<li>Func 3 [FYRKANTIGImpl]</li>
</ul>
<p><a href="/img/googlectf/native2.PNG"><a href="/img/googlectf/native2.PNG" title="native2" class="gallery-item"><img src="/img/googlectf/native2.PNG" alt="native2"></a></a>  </p>
<p>So There are two vars used from the .rdata section in the function, one of them is an array and other one doesn’t look interesting as it is a stack variable.  </p>
<p><a href="/img/googlectf/xor_arr_data.PNG"><a href="/img/googlectf/xor_arr_data.PNG" title="xor_arr_data" class="gallery-item"><img src="/img/googlectf/xor_arr_data.PNG" alt="xor_arr_data"></a></a>  </p>
<p>The function which uses is referenced in C# and looks like it is just used to initialize the array.  </p>
<p><a href="/img/googlectf/xor_arr_init.PNG"><a href="/img/googlectf/xor_arr_init.PNG" title="xor_arr_init" class="gallery-item"><img src="/img/googlectf/xor_arr_init.PNG" alt="xor_arr_init"></a></a>  </p>
<p>And yeah we get that xor function in <code>sub_39D0</code>  and FYI <code>sub_4DFC</code> is same as net51_offset_calc.<br>So till now It has xored our encrypted input with the array it just initialized.  </p>
<p><a href="/img/googlectf/xor_native_fcn.PNG"><a href="/img/googlectf/xor_native_fcn.PNG" title="xor_native_fcn" class="gallery-item"><img src="/img/googlectf/xor_native_fcn.PNG" alt="xor_native_fcn"></a></a>  </p>
<p>Moving on, we can clearly see that <code>sub_3F10</code> is used for performing some random shuffling on the resulting xored array.  </p>
<p><a href="/img/googlectf/random_shuffle_net.PNG"><a href="/img/googlectf/random_shuffle_net.PNG" title="random_shuffle_net" class="gallery-item"><img src="/img/googlectf/random_shuffle_net.PNG" alt="random_shuffle_net"></a></a>  </p>
<p>There is no point in wasting time on analysing it as we can just note the num ie. the offset (randomly generated but seeded with a static value) by setting the breakpoint as shown below and watching its value on every iteration which makes some swaps with the encrypted input list.  </p>
<p><a href="/img/googlectf/rand_shuffle_debug.PNG"><a href="/img/googlectf/rand_shuffle_debug.PNG" title="rand_shuffle_debug" class="gallery-item"><img src="/img/googlectf/rand_shuffle_debug.PNG" alt="rand_shuffle_debug"></a></a>  </p>
<p>This is what the native function looked after renaming some stuff.  </p>
<p><a href="/img/googlectf/rand_shuffle_func_renamed.PNG"><a href="/img/googlectf/rand_shuffle_func_renamed.PNG" title="rand_shuffle_func_renamed" class="gallery-item"><img src="/img/googlectf/rand_shuffle_func_renamed.PNG" alt="rand_shuffle_func_renamed"></a></a>  </p>
<p>So the main algo of <code>FYRKANTIGImpl</code> is just to xor and random shuffle our encrypted input. I’ve renamed some other functions now for better understanding.   </p>
<p><a href="/img/googlectf/native2_renamed.PNG"><a href="/img/googlectf/native2_renamed.PNG" title="native2_renamed" class="gallery-item"><img src="/img/googlectf/native2_renamed.PNG" alt="native2_renamed"></a></a>  </p>
<p>We can also script some part of defining and renaming functions just from their RVAs.<br>This also let me think that this can be implemented into a plugin package.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">define_functions</span>():</span></span><br><span class="line">  native_rvas = [<span class="number">0x1930</span>, <span class="number">0x3A90</span>, <span class="number">0x44b0</span>,]</span><br><span class="line">  native_rvas = [(<span class="number">0x400000</span> + x) <span class="keyword">for</span> x <span class="keyword">in</span> native_rvas]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ea <span class="keyword">in</span> native_rvas:</span><br><span class="line">    <span class="keyword">if</span> ea == <span class="number">0x401930</span>:</span><br><span class="line">      <span class="comment"># undefine and force convert to code as IDA doesn&#x27;t analyse it at first</span></span><br><span class="line">      <span class="built_in">print</span> <span class="string">&quot;Defining fcn GODDAG at 0x%x&quot;</span> % ea</span><br><span class="line">      <span class="built_in">print</span> <span class="string">&quot;Making&quot;</span>, ea, <span class="string">&quot;unknown and defining it to code...&quot;</span></span><br><span class="line">      idc.MakeUnkn(ea,<span class="number">1</span>)</span><br><span class="line">      idc.MakeCode(ea)</span><br><span class="line">      idc.MakeUnkn(ea+<span class="number">8</span>,<span class="number">1</span>)</span><br><span class="line">      idc.MakeCode(ea+<span class="number">7</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">if</span> ea == <span class="number">0x403A90</span>:</span><br><span class="line">        fcn_name = <span class="string">&quot;NativeGRUNDTAL_NORRVIKEN&quot;</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Defining fcn %s at 0x%x&quot;</span> % (fcn_name, ea)</span><br><span class="line">      <span class="keyword">elif</span> ea == <span class="number">0x4044B0</span>:</span><br><span class="line">        fcn_name = <span class="string">&quot;FYRKANTIGImpl&quot;</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;Defining fcn %s at 0x%x&quot;</span> % (fcn_name, ea)</span><br><span class="line">      idc.MakeFunction(ea)</span><br><span class="line">      idc.MakeNameEx(ea, fcn_name, idc.SN_NOWARN)</span><br></pre></td></tr></table></figure>


<p>This was the main algo part implemented in the native functions, which were added at runtime. Incase you are wondering what does <code>SPARSAM</code> function does, so it just converts the list returned from these native functions to a string.  </p>
<hr>
<h1 id="Z3-amp-Profit"><a href="#Z3-amp-Profit" class="headerlink" title="Z3 &amp; Profit"></a>Z3 &amp; Profit</h1><p>Hell yeah! time for z3 as we are quite sure about how this challenge works :)<br>FYI, I’m not much experienced with z3 and it always has some surprises for me.  </p>
<p>So at first I tried to just replicate the algo and check if it finds any valid solution. I initialized the input with the following constraints.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s.add(And(inp[i]&lt;=<span class="number">48</span>, inp[i]&gt;=<span class="number">125</span>))</span><br></pre></td></tr></table></figure>
<p>Then I add some If’s to encrypt our input so kinda do it all in z3</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(inp)):</span><br><span class="line">    inp[i] = If ( inp[i] - <span class="number">48</span> &lt;= <span class="number">9</span>,</span><br><span class="line">          inp[i] - <span class="number">48</span>,</span><br><span class="line">          inp[i])</span><br><span class="line">    inp[i] = If ( inp[i] - <span class="number">65</span> &lt;= <span class="number">25</span>,</span><br><span class="line">          inp[i] - <span class="number">55</span>,</span><br><span class="line">          inp[i])</span><br><span class="line">    inp[i] = If ( inp[i] - <span class="number">97</span> &lt;= <span class="number">25</span>,</span><br><span class="line">          inp[i] - <span class="number">61</span>,</span><br><span class="line">          inp[i])</span><br><span class="line">    inp[i] = If ( inp[i] == <span class="number">123</span>,</span><br><span class="line">          BitVecVal(<span class="number">62</span>,<span class="number">32</span>),</span><br><span class="line">          inp[i])</span><br><span class="line">    inp[i] = If ( inp[i] == <span class="number">125</span>,</span><br><span class="line">          BitVecVal(<span class="number">63</span>,<span class="number">32</span>),</span><br><span class="line">          BitVecVal(-<span class="number">1</span>,<span class="number">32</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And I got UNSAT! :(<br>I asked for some help from my friends but the timezones messed up and I was determined enough to solve it myself now!   </p>
<p>Finally I came up with an idea of removing just the z3 If statements and rather began with the encrypted input initially which had a range of (0, 63). And simply wrote a decrypt function for it.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_inp</span>(<span class="params">enc</span>):</span></span><br><span class="line">  dec = <span class="string">&quot;&quot;</span></span><br><span class="line">  valid_range1 = <span class="built_in">ord</span>(<span class="string">&#x27;9&#x27;</span>) - <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  valid_range2 = <span class="built_in">ord</span>(<span class="string">&#x27;Z&#x27;</span>) - <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>) - <span class="number">7</span></span><br><span class="line">  valid_range3 = <span class="built_in">ord</span>(<span class="string">&#x27;z&#x27;</span>) - <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>) - (<span class="number">7</span>+<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> c <span class="keyword">in</span> enc:</span><br><span class="line">    <span class="keyword">if</span> c &lt;= valid_range1:</span><br><span class="line">      dec += <span class="built_in">chr</span>(c + <span class="number">48</span>)</span><br><span class="line">    <span class="keyword">elif</span> c &lt;= valid_range2:</span><br><span class="line">      dec += <span class="built_in">chr</span>(c + <span class="number">55</span>)</span><br><span class="line">    <span class="keyword">elif</span> c &lt;= valid_range3:</span><br><span class="line">      dec += <span class="built_in">chr</span>(c + <span class="number">61</span>)</span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">62</span>:</span><br><span class="line">      dec += <span class="string">&#x27;&#123;&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">63</span>:</span><br><span class="line">      dec += <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dec</span><br></pre></td></tr></table></figure>

<p>WTH, Still <strong>UNSAT</strong> !!</p>
<a target="_blank" rel="noopener" href="https://media.giphy.com/media/gg2z3LuDDvOVaKVVd3/giphy-downsized.gif" title="drawing" class="gallery-item"><img src="https://media.giphy.com/media/gg2z3LuDDvOVaKVVd3/giphy-downsized.gif" alt="drawing" width="300"/></a>  

<p>And after spending some time tinkering around I figured out that it was some unsigned expressions shit in z3 which just made me mad (indescribable).  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s.add(UGE(MATHOPEN[<span class="number">29</span>], <span class="number">1</span>))</span><br><span class="line">s.add(ULE(MATHOPEN[<span class="number">0</span>] + MATHOPEN[<span class="number">1</span>] + MATHOPEN[<span class="number">2</span>] + MATHOPEN[<span class="number">3</span>] + MATHOPEN[<span class="number">4</span>] - <span class="number">130</span>, <span class="number">10</span>))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In Z3Py, the operators &lt;, &lt;=, &gt;, &gt;=, /, % and &gt;&gt; correspond to the signed versions. The corresponding unsigned operators are ULT, ULE, UGT, UGE, UDiv, URem and LShR.  </p>
</blockquote>
<p>Reference :<br><a target="_blank" rel="noopener" href="https://ericpony.github.io/z3py-tutorial/guide-examples.htm">https://ericpony.github.io/z3py-tutorial/guide-examples.htm</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor_mod</span>(<span class="params">mod_list</span>):</span></span><br><span class="line">  xor_mask = [<span class="number">0x1F</span>, <span class="number">0x23</span>, <span class="number">0x3F</span>, <span class="number">0x3F</span>, <span class="number">0x1B</span>, <span class="number">0x07</span>, <span class="number">0x37</span>, <span class="number">0x21</span>, <span class="number">0x04</span>, <span class="number">0x33</span>, <span class="number">0x09</span>, <span class="number">0x3B</span>, <span class="number">0x39</span>, <span class="number">0x28</span>, <span class="number">0x30</span>, <span class="number">0x0C</span>, <span class="number">0x0E</span>, <span class="number">0x2E</span>, <span class="number">0x3F</span>, <span class="number">0x25</span>, <span class="number">0x2A</span>, <span class="number">0x27</span>, <span class="number">0x3E</span>, <span class="number">0x0B</span>, <span class="number">0x27</span>, <span class="number">0x1C</span>, <span class="number">0x38</span>, <span class="number">0x31</span>, <span class="number">0x1E</span>, <span class="number">0x3D</span>]</span><br><span class="line"></span><br><span class="line">  lol = []</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(mod_list)):</span><br><span class="line">    lol.append(mod_list[i] ^ xor_mask[i])</span><br><span class="line">  <span class="keyword">return</span> lol</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_checksum</span>(<span class="params">mod_list</span>):</span></span><br><span class="line">  num = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(mod_list)):</span><br><span class="line">    <span class="keyword">if</span> (i != <span class="built_in">len</span>(mod_list) - <span class="number">2</span>):</span><br><span class="line">      num = mod_list[i] + num</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>):</span><br><span class="line">        num = mod_list[i] + num</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (i % <span class="number">3</span> == <span class="number">0</span>):</span><br><span class="line">        num = mod_list[i] * <span class="number">4294967294</span> + num</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (i % <span class="number">5</span> == <span class="number">0</span>):</span><br><span class="line">        num = mod_list[i] * <span class="number">4294967293</span> + num</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (i % <span class="number">7</span> == <span class="number">0</span>):</span><br><span class="line">        num = mod_list[i] * <span class="number">4</span> + num</span><br><span class="line">      </span><br><span class="line">      num &amp;= <span class="number">0xffffffff</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> num &amp; <span class="number">63</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_shuffle</span>(<span class="params">arg_list</span>):</span></span><br><span class="line">  num_list = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0xa</span>, <span class="number">0x6</span>, <span class="number">0xf</span>, <span class="number">0x3</span>, <span class="number">0x5</span>, <span class="number">0xc</span>, <span class="number">0xe</span>, <span class="number">0x3</span>, <span class="number">0x5</span>, <span class="number">0x8</span>, <span class="number">0x11</span>, <span class="number">0x17</span>, <span class="number">0x16</span>, <span class="number">0xa</span> ]</span><br><span class="line">  j = <span class="number">1</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> num_list:</span><br><span class="line">    <span class="keyword">if</span> i != j:</span><br><span class="line">      <span class="comment">#print &quot;Swapping :&quot;, (hex(arg_list[i]), hex(arg_list[j]) )</span></span><br><span class="line">      <span class="comment">#print &quot;num =&quot;, hex(i)</span></span><br><span class="line">      arg_list[i], arg_list[j] = arg_list[j], arg_list[i]</span><br><span class="line">    <span class="comment">#print i,j  </span></span><br><span class="line">    j+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> arg_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">swap_more</span>(<span class="params">arg_list</span>):</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(arg_list)-<span class="number">3</span>,<span class="number">3</span>):</span><br><span class="line">    arg_list[j], arg_list[j+<span class="number">1</span>] = arg_list[j+<span class="number">1</span>], arg_list[j]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> arg_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_inp</span>(<span class="params">enc</span>):</span></span><br><span class="line">  dec = <span class="string">&quot;&quot;</span></span><br><span class="line">  valid_range1 = <span class="built_in">ord</span>(<span class="string">&#x27;9&#x27;</span>) - <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  valid_range2 = <span class="built_in">ord</span>(<span class="string">&#x27;Z&#x27;</span>) - <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>) - <span class="number">7</span></span><br><span class="line">  valid_range3 = <span class="built_in">ord</span>(<span class="string">&#x27;z&#x27;</span>) - <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>) - (<span class="number">7</span>+<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> c <span class="keyword">in</span> enc:</span><br><span class="line">    <span class="keyword">if</span> c &lt;= valid_range1:</span><br><span class="line">      dec += <span class="built_in">chr</span>(c + <span class="number">48</span>)</span><br><span class="line">    <span class="keyword">elif</span> c &lt;= valid_range2:</span><br><span class="line">      dec += <span class="built_in">chr</span>(c + <span class="number">55</span>)</span><br><span class="line">    <span class="keyword">elif</span> c &lt;= valid_range3:</span><br><span class="line">      dec += <span class="built_in">chr</span>(c + <span class="number">61</span>)</span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">62</span>:</span><br><span class="line">      dec += <span class="string">&#x27;&#123;&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> c == <span class="number">63</span>:</span><br><span class="line">      dec += <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">final_conds</span>(<span class="params">MATHOPEN, s</span>):</span></span><br><span class="line">  </span><br><span class="line">  s.add(MATHOPEN[<span class="number">1</span>] == <span class="number">25</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">2</span>] == <span class="number">23</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">9</span>] == <span class="number">9</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">20</span>] == <span class="number">45</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">26</span>] == <span class="number">7</span>)</span><br><span class="line">  s.add(UGE(MATHOPEN[<span class="number">8</span>], <span class="number">15</span>))</span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">12</span>], <span class="number">4</span>))</span><br><span class="line">  s.add(UGE(MATHOPEN[<span class="number">14</span>], <span class="number">48</span>))</span><br><span class="line">  s.add(UGE(MATHOPEN[<span class="number">29</span>], <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">0</span>] + MATHOPEN[<span class="number">1</span>] + MATHOPEN[<span class="number">2</span>] + MATHOPEN[<span class="number">3</span>] + MATHOPEN[<span class="number">4</span>] - <span class="number">130</span>, <span class="number">10</span>))</span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">5</span>] + MATHOPEN[<span class="number">6</span>] + MATHOPEN[<span class="number">7</span>] + MATHOPEN[<span class="number">8</span>] + MATHOPEN[<span class="number">9</span>] - <span class="number">140</span>, <span class="number">10</span>))</span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">10</span>] + MATHOPEN[<span class="number">11</span>] + MATHOPEN[<span class="number">12</span>] + MATHOPEN[<span class="number">13</span>] + MATHOPEN[<span class="number">14</span>] - <span class="number">150</span> ,<span class="number">10</span>)) </span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">15</span>] + MATHOPEN[<span class="number">16</span>] + MATHOPEN[<span class="number">17</span>] + MATHOPEN[<span class="number">18</span>] + MATHOPEN[<span class="number">19</span>] - <span class="number">160</span> ,<span class="number">10</span>)) </span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">20</span>] + MATHOPEN[<span class="number">21</span>] + MATHOPEN[<span class="number">22</span>] + MATHOPEN[<span class="number">23</span>] + MATHOPEN[<span class="number">24</span>] - <span class="number">170</span> ,<span class="number">10</span>)) </span><br><span class="line"></span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">0</span>] + MATHOPEN[<span class="number">5</span>] + MATHOPEN[<span class="number">10</span>] + MATHOPEN[<span class="number">15</span>] + MATHOPEN[<span class="number">20</span>] + MATHOPEN[<span class="number">25</span>] - <span class="number">172</span>, <span class="number">6</span>)) </span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">1</span>] + MATHOPEN[<span class="number">6</span>] + MATHOPEN[<span class="number">11</span>] + MATHOPEN[<span class="number">16</span>] +MATHOPEN[<span class="number">21</span>] + MATHOPEN[<span class="number">26</span>] - <span class="number">162</span>, <span class="number">6</span>)) </span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">2</span>] + MATHOPEN[<span class="number">7</span>] + MATHOPEN[<span class="number">12</span>] + MATHOPEN[<span class="number">17</span>]+ MATHOPEN[<span class="number">22</span>] + MATHOPEN[<span class="number">27</span>] - <span class="number">152</span>, <span class="number">6</span>)) </span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">3</span>] + MATHOPEN[<span class="number">8</span>] + MATHOPEN[<span class="number">13</span>] + MATHOPEN[<span class="number">18</span>] + MATHOPEN[<span class="number">23</span>] - <span class="number">142</span>, <span class="number">6</span>)) </span><br><span class="line">  s.add(ULE(MATHOPEN[<span class="number">4</span>] + MATHOPEN[<span class="number">9</span>] + MATHOPEN[<span class="number">14</span>] + MATHOPEN[<span class="number">19</span>] + MATHOPEN[<span class="number">24</span>] + MATHOPEN[<span class="number">29</span>] - <span class="number">132</span>, <span class="number">6</span>)) </span><br><span class="line"></span><br><span class="line">  num45 = ((MATHOPEN[<span class="number">7</span>] + (MATHOPEN[<span class="number">27</span>] * <span class="number">3</span>)) * <span class="number">3</span> - MATHOPEN[<span class="number">5</span>] * <span class="number">13</span>) - <span class="number">57</span></span><br><span class="line">  s.add(ULE(num45, <span class="number">28</span>))</span><br><span class="line">  </span><br><span class="line">  num45 = (MATHOPEN[<span class="number">22</span>] * <span class="number">3</span> + ((MATHOPEN[<span class="number">14</span>] &lt;&lt; <span class="number">2</span>) - (MATHOPEN[<span class="number">20</span>] * <span class="number">5</span>))) - <span class="number">12</span></span><br><span class="line">  s.add(ULE(num45, <span class="number">70</span>))</span><br><span class="line"></span><br><span class="line">  num46 = (MATHOPEN[<span class="number">14</span>] + (MATHOPEN[<span class="number">16</span>] * <span class="number">2</span>)) * <span class="number">2</span> + ((MATHOPEN[<span class="number">15</span>] - ( MATHOPEN[<span class="number">18</span>] * <span class="number">2</span>)) * <span class="number">3</span>) - MATHOPEN[<span class="number">17</span>] * <span class="number">5</span></span><br><span class="line">  s.add(MATHOPEN[<span class="number">13</span>] + num46 == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  s.add(MATHOPEN[<span class="number">5</span>] == MATHOPEN[<span class="number">6</span>] * <span class="number">2</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">29</span>] + MATHOPEN[<span class="number">7</span>] == <span class="number">59</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">0</span>] == MATHOPEN[<span class="number">17</span>] * <span class="number">6</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">8</span>] == MATHOPEN[<span class="number">9</span>] * <span class="number">4</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">11</span>] &lt;&lt; <span class="number">1</span> == MATHOPEN[<span class="number">13</span>] * <span class="number">3</span>)</span><br><span class="line">  s.add(MATHOPEN[<span class="number">13</span>] + MATHOPEN[<span class="number">29</span>] + MATHOPEN[<span class="number">11</span>] + MATHOPEN[<span class="number">4</span>] == MATHOPEN[<span class="number">19</span>])</span><br><span class="line">  s.add(MATHOPEN[<span class="number">10</span>] == MATHOPEN[<span class="number">12</span>] * <span class="number">13</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  s = Solver()</span><br><span class="line">  inp = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    b = BitVec(<span class="string">&quot;%d_i&quot;</span> % i, <span class="number">32</span>)</span><br><span class="line">    inp.append(b)</span><br><span class="line">    s.add(ULE(inp[i], <span class="number">63</span>))</span><br><span class="line"></span><br><span class="line">  xor_res_list = xor_mod(inp)</span><br><span class="line">  res1 = random_shuffle(xor_res_list)</span><br><span class="line">  res2 = swap_more(res1)</span><br><span class="line"></span><br><span class="line">  s.add(Distinct(res2))</span><br><span class="line">  </span><br><span class="line">  ret_num = get_checksum(res2)</span><br><span class="line"></span><br><span class="line">  s.add(res2[<span class="number">28</span>] == ret_num )</span><br><span class="line"></span><br><span class="line">  final_conds(res2, s)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">print</span> s.check()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    sol = s.model()</span><br><span class="line">    flag = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(inp)):</span><br><span class="line">      c = inp[i]</span><br><span class="line">      flag.append(<span class="built_in">int</span>(<span class="built_in">str</span>(sol[c])))</span><br><span class="line">    <span class="built_in">print</span> flag</span><br><span class="line">    <span class="built_in">print</span> decode_inp(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">  main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sat</span><br><span class="line">[12, 29, 15, 62, 12, 51, 51, 12, 47, 53, 18, 54, 32, 40, 44, 53, 39, 11, 56, 55, 27, 40, 36, 47, 47, 60, 15, 56, 49, 63]</span><br><span class="line">CTF&#123;CppClrIsWeirdButReallyFun&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Solution-Files"><a href="#Solution-Files" class="headerlink" title="Solution Files"></a>Solution Files</h1><p>I’ve uploaded all the files including the IDAPython and z3 solver scripts along with the idb file on my github here :</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/mrT4ntr4/Challenge-Solution-Files/tree/master/GoogleCTF_2020_dotNet">mrT4ntr4/Challenge-Solution-Files/GoogleCTF_2020_dotNet</a></p>
</blockquote>
<p>I hope you liked this writeup :)<br>Well, Thanks for reading it…   </p>
<p><strong>STAY SAFE !</strong></p>
<a target="_blank" rel="noopener" href="https://media.giphy.com/media/1zijfEWLg9bIuAXna7/giphy.gif" title="drawing" class="gallery-item"><img src="https://media.giphy.com/media/1zijfEWLg9bIuAXna7/giphy.gif" alt="drawing" width="300"/></a> 
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Challenge"><span class="toc-number">1.</span> <span class="toc-text">Challenge</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TL-DR"><span class="toc-number">2.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">3.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Static-Analysis"><span class="toc-number">4.</span> <span class="toc-text">Static Analysis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dynamic-Analysis"><span class="toc-number">5.</span> <span class="toc-text">Dynamic Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Harmony-Magic"><span class="toc-number">5.1.</span> <span class="toc-text">Harmony Magic</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-Harmony-works"><span class="toc-number">5.1.1.</span> <span class="toc-text">How Harmony works</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysing-Native-Functions-with-IDAPython"><span class="toc-number">5.2.</span> <span class="toc-text">Analysing Native Functions with IDAPython</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Z3-amp-Profit"><span class="toc-number">6.</span> <span class="toc-text">Z3 &amp; Profit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Solution-Files"><span class="toc-number">7.</span> <span class="toc-text">Solution Files</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://mrt4ntr4.github.io/GoogleCTF-dotNet/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&text=Google CTF 2020 [.Net-RE]"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&is_video=false&description=Google CTF 2020 [.Net-RE]"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Google CTF 2020 [.Net-RE]&body=Check out this article: https://mrt4ntr4.github.io/GoogleCTF-dotNet/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&title=Google CTF 2020 [.Net-RE]"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&name=Google CTF 2020 [.Net-RE]&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://mrt4ntr4.github.io/GoogleCTF-dotNet/&t=Google CTF 2020 [.Net-RE]"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021
    Suraj Malhotra
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"CTRL+C\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
      setTimeout(function() {
        e.trigger.setAttribute('aria-label', "CTRL+C");
      }, 2000);
    })
  })
  </script>


<script src="/js/main.js"></script>





    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-132815766-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-132815766-1');
    </script>








</body>
</html>
