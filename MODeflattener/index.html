<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="MODeflattener - Miasm&#39;s OLLVM Deflattener">
<meta property="og:url" content="https://mrt4ntr4.github.io/MODeflattener/index.html">
<meta property="og:site_name" content="mrT4ntr4&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/cff_pass.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/cff_illustration.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/state_var.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/relevant_blocks.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/ssacfg_401a9d.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/cmov_example.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/defuse_state_var_401a9d.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/results_dg.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/modeflattener/dec_comparision.png">
<meta property="article:published_time" content="2021-06-25T22:00:00.000Z">
<meta property="article:modified_time" content="2021-06-26T04:56:17.328Z">
<meta property="article:author" content="Suraj Malhotra">
<meta property="article:tag" content="Obfuscation">
<meta property="article:tag" content="Miasm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mrt4ntr4.github.io/img/modeflattener/cff_pass.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
        
      
    
    <!-- title -->
    <title>MODeflattener - Miasm&#39;s OLLVM Deflattener</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/feed.xml" title="mrT4ntr4&#39;s Blog" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.3.0"></head>

<div class="background">
    <div class="banner">
<div id="blogtitle" class="blogtitle">mrT4ntr4&#39;s Blog</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/FCSC21-CTF-VMV/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://mrt4ntr4.github.io/MODeflattener/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://mrt4ntr4.github.io/MODeflattener/&text=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mrt4ntr4.github.io/MODeflattener/&is_video=false&description=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MODeflattener - Miasm&#39;s OLLVM Deflattener&body=Check out this article: https://mrt4ntr4.github.io/MODeflattener/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://mrt4ntr4.github.io/MODeflattener/&name=MODeflattener - Miasm&#39;s OLLVM Deflattener&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://mrt4ntr4.github.io/MODeflattener/&t=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Control-Flow-Flattenning"><span class="toc-number">1.</span> <span class="toc-text">Control Flow Flattenning</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Getting-Flattening-Information"><span class="toc-number">2.</span> <span class="toc-text">Getting Flattening Information</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#State-Variable"><span class="toc-number">3.</span> <span class="toc-text">State Variable</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Relevant-Blocks"><span class="toc-number">4.</span> <span class="toc-text">Relevant Blocks</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Use-of-SSA-Expressions"><span class="toc-number">5.</span> <span class="toc-text">Use of SSA Expressions</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Removing-Useless-Instructions"><span class="toc-number">6.</span> <span class="toc-text">Removing Useless Instructions</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Patching-and-Reconstructing-the-Control-Flow"><span class="toc-number">7.</span> <span class="toc-text">Patching and Reconstructing the Control Flow</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Final-Results"><span class="toc-number">8.</span> <span class="toc-text">Final Results</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Graph-View"><span class="toc-number">8.1.</span> <span class="toc-text">Graph View</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#F5-View"><span class="toc-number">8.2.</span> <span class="toc-text">F5 View</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Get-MODeflattener"><span class="toc-number">9.</span> <span class="toc-text">Get MODeflattener</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bonus"><span class="toc-number">9.1.</span> <span class="toc-text">Bonus</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#References"><span class="toc-number">10.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MODeflattener - Miasm&#39;s OLLVM Deflattener
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Suraj Malhotra</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-06-25T22:00:00.000Z" itemprop="datePublished">2021-06-26</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Tools/">Tools</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Miasm/" rel="tag">Miasm</a>, <a class="tag-link-link" href="/tags/Obfuscation/" rel="tag">Obfuscation</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p>So recently a challenge(<a href="/files/modeflattener/layers-729d7c2b1e12d9598e9bf6bc247ce0ba.zip" target="_blank">Layers</a>) from <a target="_blank" rel="noopener" href="https://ctftime.org/event/1317">3kCTF</a> featured control flow flattening using OLLVM. Although I did know about control flow flattening I hadn’t encountered it personally. And as I’ve been experimenting with miasm for the past few days I thought of developing a tool to deal with it.  </p>
<h1 id="Control-Flow-Flattenning"><a href="#Control-Flow-Flattenning" class="headerlink" title="Control Flow Flattenning"></a>Control Flow Flattenning</h1><p><a href="/img/modeflattener/cff_pass.png" title="cff transformation" class="gallery-item"><img src="/img/modeflattener/cff_pass.png" alt="cff transformation"></a></p>
<p>Control flow flattening is an interesting and clever technique to make a reverse engineer’s day difficult. It basically puts all the basic blocks in a function at the same level and destroys the control flow. It then uses a dispatcher to reconstruct the control flow along with a control/state variable which is updated at the end of each block.  </p>
<p>The following illustration depicts various parts of a flattened function.  </p>
<p><a href="/img/modeflattener/cff_illustration.png" title="cff_illustration" class="gallery-item"><img src="/img/modeflattener/cff_illustration.png" alt="cff_illustration"></a></p>
<p>Various obfuscators employ their own version of control flow flattening transformations :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/obfuscator-llvm/obfuscator/wiki/Control-Flow-Flattening">OLLVM</a></li>
<li><a target="_blank" rel="noopener" href="http://tigress.cs.arizona.edu/transformPage/docs/flatten/index.html">Tigress</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/meme/hellscape#flattening">Hellscape</a></li>
</ul>
<blockquote>
<p>CAUTION : Only Static Analysis used !<br>As we are primarly focusing on OLLVM for now we can just use some static analysis techniques to deobfuscate it, but for developing a universal tool to deal with this kind of obfuscation we need to look more into dynamic approaches.<br><em>For example, <a target="_blank" rel="noopener" href="https://essay.utwente.nl/67522/1/Scrinzi_MA_SCS.pdf">this</a> looks interesting.</em>  </p>
</blockquote>
<hr>
<h1 id="Getting-Flattening-Information"><a href="#Getting-Flattening-Information" class="headerlink" title="Getting Flattening Information"></a>Getting Flattening Information</h1><p>To start off, we need to identify the relevant blocks and the dispatcher. To find the dispatcher we need to first find the pre-dispatcher. This is because we rely on the fact that the pre-dispatcher has the maximum number of predecessors, it is easy to identify. Later we can just get the first successor of the pre-dispatcher to get the dispatcher, easy!</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_cff_info</span>(<span class="params">asmcfg</span>):</span></span><br><span class="line">    preds = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> blk <span class="keyword">in</span> asmcfg.blocks:</span><br><span class="line">        offset = asmcfg.loc_db.get_location_offset(blk.loc_key)</span><br><span class="line">        preds[offset] = asmcfg.predecessors(blk.loc_key)</span><br><span class="line">    pre_dispatcher = <span class="built_in">sorted</span>(preds, key=<span class="keyword">lambda</span> key: <span class="built_in">len</span>(preds[key]), reverse=<span class="literal">True</span>)[<span class="number">0</span>]</span><br><span class="line">    dispatcher = asmcfg.successors(asmcfg.loc_db.get_offset_location(pre_dispatcher))[<span class="number">0</span>]</span><br><span class="line">    dispatcher = asmcfg.loc_db.get_location_offset(dispatcher)</span><br></pre></td></tr></table></figure>
<p>Also we now already have the relevant blocks as they are just the predecessors to the pre-dispatcher we just found!</p>
<hr>
<h1 id="State-Variable"><a href="#State-Variable" class="headerlink" title="State Variable"></a>State Variable</h1><p>The state variable is responsible for maintaining the control flow in the flattened function.  </p>
<p><a href="/img/modeflattener/state_var.png" title="state_var" class="gallery-item"><img src="/img/modeflattener/state_var.png" alt="state_var"></a></p>
<p>The state variable is always initialized before the dispatcher and is used in the first line of the dispatcher. We can use this information to get the state variable automatically.  </p>
<hr>
<h1 id="Relevant-Blocks"><a href="#Relevant-Blocks" class="headerlink" title="Relevant Blocks"></a>Relevant Blocks</h1><p>The blocks that are aligned at the same level in the disassembly graph and include the useful code are known as relevant blocks. These blocks update the value of the state variable at the very end.<br><strong>Note:</strong> Currently we also add the <em>tail of the backbone</em> to our relevant blocks as we are just depending on the predecessors of the pre-dispatcher. Basically the tail is used if the state variable value doesn’t satisfy any condition in the backbone. It doesn’t update the state variable and only has a jump to pre-dispatcher.  So if we don’t find any code related to modification of the state variable in a relevant block we mark this as tail.  </p>
<p>Having most of the information we can now proceed with deflattening the flow.<br>Basically we have two types of relevant blocks:  </p>
<p><a href="/img/modeflattener/relevant_blocks.png" title="relevant_blocks" class="gallery-item"><img src="/img/modeflattener/relevant_blocks.png" alt="relevant_blocks"></a>  </p>
<ul>
<li><p><strong>Simple</strong><br>  Block without any conditions, so the state variable is always updated with the same value. Only one instruction is used to modify the state variable.</p>
</li>
<li><p><strong>Conditional</strong><br>  Blocks with conditional statements and loops. Here the state variable could have two possible values depending on whether the condition results in a true or false. These often end with a <code>cmov</code> instruction. Several instructions are used to modify the state variable.  </p>
</li>
</ul>
<hr>
<h1 id="Use-of-SSA-Expressions"><a href="#Use-of-SSA-Expressions" class="headerlink" title="Use of SSA Expressions"></a>Use of SSA Expressions</h1><p>We further simplify the IR to SSA to deal with the conditional relevant blocks.<br>We only make use of <code>do_propagate_expressions</code> ssa simplification pass. </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">head = loc_db.get_offset_location(addr)</span><br><span class="line">ssa_simplifier = IRCFGSimplifierSSA(lifter)</span><br><span class="line">ssa = ssa_simplifier.ircfg_to_ssa(ircfg, head)</span><br><span class="line">ssa_simplifier.do_propagate_expressions(ssa, head)</span><br></pre></td></tr></table></figure>
<p><a href="/img/modeflattener/ssacfg_401a9d.png" title="ssacfg" class="gallery-item"><img src="/img/modeflattener/ssacfg_401a9d.png" alt="ssacfg"></a></p>
<p>In the SSA form we observe a Phi operation which basically means that one of the variables arriving from different predeccesors is chosen depending on which path the control flow took.  </p>
<p><a href="/img/modeflattener/cmov_example.png" title="cmov_example" class="gallery-item"><img src="/img/modeflattener/cmov_example.png" alt="cmov_example"></a></p>
<p>In the above example we observe that if the condition is <em>true</em> the state variable is assigned the value = 0x7A3F9928 (RCX.4) and if <em>false</em> value = 0x30110039 (RCX.2).</p>
<p>We get the block where the phi variables are assigned using the following code and then get their values from those blocks.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> irblock_has_phi(irblock):</span><br><span class="line">    <span class="keyword">for</span> dst, sources <span class="keyword">in</span> viewitems(irblock[<span class="number">0</span>]):</span><br><span class="line">        phi_vars = sources.args</span><br><span class="line">        parent_blks = get_phi_sources_parent_block(</span><br><span class="line">            ircfg,</span><br><span class="line">            irblock.loc_key,</span><br><span class="line">            phi_vars</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>We get the following information from a relevant block:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x401a9d</span>: &#123;<span class="string">&#x27;cond&#x27;</span>: <span class="string">&#x27;CMOVB&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;false_next&#x27;</span>: <span class="number">0x30110039</span>,</span><br><span class="line">           <span class="string">&#x27;true_next&#x27;</span>: <span class="number">0x7a3f9928</span>&#125;</span><br></pre></td></tr></table></figure>
<p>Now we need to iterate over the backbone blocks and get their destinations if it includes condition regarding any of the possible state variable values. We can map these to the original state variable values and make use of it to correct the flow.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(arg, ExprInt):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">int</span>(arg) <span class="keyword">in</span> val_list:</span><br><span class="line">        cmp_val = <span class="built_in">int</span>(arg)</span><br><span class="line">        var, locs = irblock[-<span class="number">1</span>].items()[<span class="number">0</span>]</span><br><span class="line">        true_dst = main_ircfg.loc_db.get_location_offset(locs.src1.loc_key)</span><br><span class="line">        backbone[<span class="built_in">hex</span>(cmp_val)] = <span class="built_in">hex</span>(true_dst)</span><br></pre></td></tr></table></figure>
<p>After resolving these values from the backbone, the final result looks like this.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x401a9d</span>: &#123;<span class="string">&#x27;cond&#x27;</span>: <span class="string">&#x27;CMOVB&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;false_next&#x27;</span>: <span class="number">0x401bb0</span>,</span><br><span class="line">           <span class="string">&#x27;true_next&#x27;</span>: <span class="number">0x401af5</span>&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Removing-Useless-Instructions"><a href="#Removing-Useless-Instructions" class="headerlink" title="Removing Useless Instructions"></a>Removing Useless Instructions</h1><p>Modeflattener finds the addresses to nop out using the def-use graph for the state variable. This is one of the data flow analysis feature provided by miasm. This algorithm returns all the instructions affecting the state variable and therefore we call these as useless instructions. Read more about it <a target="_blank" rel="noopener" href="https://miasm.re/blog/2017/02/03/data_flow_analysis_depgraph.html">here</a>  </p>
<p><a href="/img/modeflattener/defuse_state_var_401a9d.png" title="defuse_state_var" class="gallery-item"><img src="/img/modeflattener/defuse_state_var_401a9d.png" alt="defuse_state_var"></a></p>
<p>The state variable is always located in one of the leaves in the graph, we can easily get all of its parents using the following code.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_state_var_usedefs</span>(<span class="params">ircfg, search_var</span>):</span></span><br><span class="line">    var_addrs = <span class="built_in">set</span>()</span><br><span class="line">    reachings = ReachingDefinitions(ircfg)</span><br><span class="line">    digraph = DiGraphDefUse(reachings)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> leaf <span class="keyword">in</span> digraph.leaves():</span><br><span class="line">        <span class="keyword">if</span> leaf.var == search_var:</span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> (digraph.reachable_parents(leaf)):</span><br><span class="line">                var_addrs.add(ircfg.get_block(x.label)[x.index].instr.offset)</span><br><span class="line">    <span class="keyword">return</span> var_addrs</span><br></pre></td></tr></table></figure>
<h1 id="Patching-and-Reconstructing-the-Control-Flow"><a href="#Patching-and-Reconstructing-the-Control-Flow" class="headerlink" title="Patching and Reconstructing the Control Flow"></a>Patching and Reconstructing the Control Flow</h1><p>While cleaning these useless instructions we have to keep in mind that the call instructions will get affected by this as they are based on relative offsets.<br>We can fix it using the following code :</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">rel = <span class="keyword">lambda</span> addr, patch_addr: <span class="built_in">hex</span>(addr - patch_addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> instr <span class="keyword">in</span> instrs:</span><br><span class="line">    <span class="comment">#omitting useless instructions</span></span><br><span class="line">    <span class="keyword">if</span> instr.offset <span class="keyword">not</span> <span class="keyword">in</span> nop_addrs:</span><br><span class="line">        <span class="keyword">if</span> instr.is_subcall():</span><br><span class="line">            <span class="comment">#generate asm for fixed calls with relative addrs</span></span><br><span class="line">            patch_addr = start_addr + <span class="built_in">len</span>(final_patch)</span><br><span class="line">            tgt = loc_db.get_location_offset(instr.args[<span class="number">0</span>].loc_key)</span><br><span class="line">            call_patch_str = <span class="string">&quot;CALL %s&quot;</span> % rel(tgt, patch_addr)</span><br><span class="line">            call_patch = asmb(call_patch_str, loc_db)</span><br><span class="line">            final_patch += call_patch</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment">#add the original bytes</span></span><br><span class="line">            final_patch += instr.b</span><br></pre></td></tr></table></figure>
<p>At last we need to generate a patch for jumps and reconstruct the control flow.<br>For a simple relevant block we only need a single patch.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">asmb = <span class="keyword">lambda</span> patch_str, loc_db: mn_x86.asm(mn_x86.fromstring(patch_str, loc_db, <span class="number">32</span>))[<span class="number">0</span>]</span><br><span class="line">patch_addr = start_addr + <span class="built_in">len</span>(final_patch)</span><br><span class="line"></span><br><span class="line">n_addr = link[<span class="string">&#x27;next&#x27;</span>]</span><br><span class="line">patch = <span class="string">&quot;JMP %s&quot;</span> % rel(n_addr, patch_addr)</span><br><span class="line">jmp_patches = asmb(patch, loc_db)</span><br></pre></td></tr></table></figure>
<p>We have two instruction patches for a conditional relevant block. We replace the conditional move with a conditional jump to the true address and add another jump in succession to the false address.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t_addr = link[<span class="string">&#x27;true_next&#x27;</span>]</span><br><span class="line">f_addr = link[<span class="string">&#x27;false_next&#x27;</span>]</span><br><span class="line">jcc = link[<span class="string">&#x27;cond&#x27;</span>].replace(<span class="string">&#x27;CMOV&#x27;</span>, <span class="string">&#x27;J&#x27;</span>)</span><br><span class="line"></span><br><span class="line">patch1_str = <span class="string">&quot;%s %s&quot;</span> % (jcc, rel(t_addr, patch_addr))</span><br><span class="line">jmp_patches += asmb(patch1_str, loc_db)</span><br><span class="line">patch_addr += <span class="built_in">len</span>(jmp_patches)</span><br><span class="line"></span><br><span class="line">patch2_str = <span class="string">&quot;JMP %s&quot;</span> % (rel(f_addr, patch_addr))</span><br><span class="line">jmp_patches += asmb(patch2_str, loc_db)</span><br></pre></td></tr></table></figure>
<p>We can nop out the backbone as it is useless now.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">backbone_start, backbone_end = dispatcher, tail.offset + tail.l</span><br><span class="line">nop_len = backbone_end - backbone_start</span><br><span class="line">patches[backbone_start] = <span class="string">b&quot;\x90&quot;</span> * nop_len</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Final-Results"><a href="#Final-Results" class="headerlink" title="Final Results"></a>Final Results</h1><h2 id="Graph-View"><a href="#Graph-View" class="headerlink" title="Graph View"></a>Graph View</h2><p><a href="/img/modeflattener/results_dg.png" title="results" class="gallery-item"><img src="/img/modeflattener/results_dg.png" alt="results"></a></p>
<h2 id="F5-View"><a href="#F5-View" class="headerlink" title="F5 View"></a>F5 View</h2><p><a href="/img/modeflattener/dec_comparision.png" title="dec_comparision" class="gallery-item"><img src="/img/modeflattener/dec_comparision.png" alt="dec_comparision"></a></p>
<hr>
<h1 id="Get-MODeflattener"><a href="#Get-MODeflattener" class="headerlink" title="Get MODeflattener"></a>Get MODeflattener</h1><blockquote>
<p>I’ve open sourced the tool on my github. I’ve added some samples to test it as well. Try it out!<br>  <a target="_blank" rel="noopener" href="https://github.com/mrT4ntr4/MODeflattener">https://github.com/mrT4ntr4/MODeflattener</a></p>
</blockquote>
<h2 id="Bonus"><a href="#Bonus" class="headerlink" title="Bonus"></a>Bonus</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://gist.github.com/mrphrazer/da32217f231e1dd842986f94aa6d9d37">Tim Blazytko’s flattening heuristic script</a><br>While disassembling the specified function we can look out for other functions used by it and can make use of this script to automatically detect whether it is a flattened one and try to deobfuscate it. This has already been integrated into the tool!    </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://gist.github.com/JusticeRage/795badf81fe59454963a06070d132b06">nop-hider idapython script</a><br>  This script hides the nop instructions from IDA graph view as the backbone is converted into a long nop chain after deobfuscation.  </p>
</li>
</ul>
<hr>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><p><a target="_blank" rel="noopener" href="https://rpis.ec/blog/dissection-llvm-obfuscator-p1/">Dissecting LLVM Obfuscator - RPISEC</a><br><a target="_blank" rel="noopener" href="https://synthesis.to/2021/03/03/flattening_detection.html">Automated Detection of Control-flow Flattening - Tim Blazytko</a>  </p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Control-Flow-Flattenning"><span class="toc-number">1.</span> <span class="toc-text">Control Flow Flattenning</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Getting-Flattening-Information"><span class="toc-number">2.</span> <span class="toc-text">Getting Flattening Information</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#State-Variable"><span class="toc-number">3.</span> <span class="toc-text">State Variable</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Relevant-Blocks"><span class="toc-number">4.</span> <span class="toc-text">Relevant Blocks</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Use-of-SSA-Expressions"><span class="toc-number">5.</span> <span class="toc-text">Use of SSA Expressions</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Removing-Useless-Instructions"><span class="toc-number">6.</span> <span class="toc-text">Removing Useless Instructions</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Patching-and-Reconstructing-the-Control-Flow"><span class="toc-number">7.</span> <span class="toc-text">Patching and Reconstructing the Control Flow</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Final-Results"><span class="toc-number">8.</span> <span class="toc-text">Final Results</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Graph-View"><span class="toc-number">8.1.</span> <span class="toc-text">Graph View</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#F5-View"><span class="toc-number">8.2.</span> <span class="toc-text">F5 View</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Get-MODeflattener"><span class="toc-number">9.</span> <span class="toc-text">Get MODeflattener</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Bonus"><span class="toc-number">9.1.</span> <span class="toc-text">Bonus</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#References"><span class="toc-number">10.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://mrt4ntr4.github.io/MODeflattener/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://mrt4ntr4.github.io/MODeflattener/&text=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mrt4ntr4.github.io/MODeflattener/&is_video=false&description=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MODeflattener - Miasm&#39;s OLLVM Deflattener&body=Check out this article: https://mrt4ntr4.github.io/MODeflattener/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://mrt4ntr4.github.io/MODeflattener/&title=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://mrt4ntr4.github.io/MODeflattener/&name=MODeflattener - Miasm&#39;s OLLVM Deflattener&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://mrt4ntr4.github.io/MODeflattener/&t=MODeflattener - Miasm&#39;s OLLVM Deflattener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021
    Suraj Malhotra
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"CTRL+C\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
      setTimeout(function() {
        e.trigger.setAttribute('aria-label', "CTRL+C");
      }, 2000);
    })
  })
  </script>


<script src="/js/main.js"></script>





    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-132815766-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-132815766-1');
    </script>








</body>
</html>
