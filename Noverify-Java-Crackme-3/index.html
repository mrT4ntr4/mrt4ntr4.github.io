<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="Solving Java Reversing Challenges - Noverify&#39;s Crackme 3">
<meta property="og:url" content="https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/index.html">
<meta property="og:site_name" content="MrT4ntr4&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/thumb.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/sample_run.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/jadx_classes.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/dumper.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/jadx_err.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/method_call_0.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/arr_type_codes.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/solved.PNG">
<meta property="og:image" content="https://media.giphy.com/media/kHmBzIxx4LRSM/giphy.gif">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/bytecode_visualizer_err.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/jar_extract.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/fwd_slash.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/class_mode.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/edit_assembler.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/edit_0.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/edited_0_output.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/agent_1.PNG">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/noverify/agent_2.PNG">
<meta property="article:published_time" content="2020-07-19T07:00:00.000Z">
<meta property="article:modified_time" content="2021-01-20T07:54:40.364Z">
<meta property="article:author" content="Suraj Malhotra">
<meta property="article:tag" content="writeup">
<meta property="article:tag" content="crackme">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mrt4ntr4.github.io/img/noverify/thumb.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
        
      
    
    <!-- title -->
    <title>Solving Java Reversing Challenges - Noverify&#39;s Crackme 3</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/feed.xml" title="MrT4ntr4&#39;s Blog" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.3.0"></head>

<div class="background">
    <div class="banner">
<div id="blogtitle" class="blogtitle">MrT4ntr4&#39;s Blog</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/GoogleCTF-dotNet/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/How-Analysing-an-AgentTesla-Could-Lead-To-Attackers-Inbox-2/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&text=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&is_video=false&description=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3&body=Check out this article: https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&name=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&t=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TLDR"><span class="toc-number">1.</span> <span class="toc-text">TLDR</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge"><span class="toc-number">1.1.</span> <span class="toc-text">Challenge</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Static-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Static Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Indy-in-Action"><span class="toc-number">3.1.</span> <span class="toc-text">Indy in Action</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Algorithm"><span class="toc-number">3.2.</span> <span class="toc-text">Algorithm</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dynamic-Analysis"><span class="toc-number">4.</span> <span class="toc-text">Dynamic Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Dynamic-Instrumentation-using-ASM"><span class="toc-number">4.1.</span> <span class="toc-text">Dynamic Instrumentation using ASM</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Solution-and-Source-files"><span class="toc-number">5.</span> <span class="toc-text">Solution and Source files</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Solving Java Reversing Challenges - Noverify&#39;s Crackme 3
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Suraj Malhotra</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-07-19T07:00:00.000Z" itemprop="datePublished">2020-07-19</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/crackmes-one/">crackmes.one</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/crackme/" rel="tag">crackme</a>, <a class="tag-link-link" href="/tags/java/" rel="tag">java</a>, <a class="tag-link-link" href="/tags/writeup/" rel="tag">writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p><a href="/img/noverify/thumb.png" title="banner" class="gallery-item"><img src="/img/noverify/thumb.png" alt="banner"></a></p>
<h1 id="TLDR"><a href="#TLDR" class="headerlink" title="TLDR"></a>TLDR</h1><p>This time, we solve a Java crackme which focuses on InvokeDynamic instruction and has some basic obfuscation. We analyse the java bytecode instructions and use regex to bypass obfuscation.<br>And then, experiment with dynamic instrumentation to later debug and understand it. Also we talk about the tooling process often required to solve java reversing challenges.  </p>
<h2 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h2><blockquote>
<p>Download <a href="https://crackmes.one/crackme/5eded0f533c5d449d91ae783"  target="_blank">noverify’s crackme 3</a></p>
</blockquote>
<hr>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Ahh, So It’s been a while I’ve written anything!  </p>
<p>The last two weeks I’ve been fiddling around with reversing java apps and got to try these cool crackmes by <a target="_blank" rel="noopener" href="https://github.com/GraxCode/java-crackmes">@graxcoding</a>.<br>So the third one checks our input of a 64 bit long integer to validate it.  </p>
<p><a href="/img/noverify/sample_run.PNG"><a href="/img/noverify/sample_run.PNG" title="sample_run" class="gallery-item"><img src="/img/noverify/sample_run.PNG" alt="sample_run"></a></a>  </p>
<p>Jadx fails to extract any classes, not cool!  </p>
<p><a href="/img/noverify/jadx_classes.PNG"><a href="/img/noverify/jadx_classes.PNG" title="jadx_classes" class="gallery-item"><img src="/img/noverify/jadx_classes.PNG" alt="jadx_classes"></a></a>  </p>
<p>Also I tried using the jar tool’s <code>xf</code> option and other tools like Bytecode Viewer but got the same result ¯\<em>(ツ)</em>/¯<br>Then I remembered a video from <a target="_blank" rel="noopener" href="https://youtu.be/QAzs66psLjY">MalwareAnalysisForHedgehogs</a> where he used this <a target="_blank" rel="noopener" href="https://github.com/Securityinbits/blog-posts/tree/master/java_agent">dumper</a> as a java agent to dump the classes from an obfuscated jar file.<br>Basically our agent class must implement a public static premain method similar in principle to main method. After the JVM has initialized, the premain method will be called, then the real application main method.  </p>
<p><a href="/img/noverify/dumper.PNG"><a href="/img/noverify/dumper.PNG" title="dumper" class="gallery-item"><img src="/img/noverify/dumper.PNG" alt="dumper"></a></a>  </p>
<p>It worked perfectly and we have the <code>me_nov_crackme_CrackMe.class</code> file and can work on it.  </p>
<hr>
<h1 id="Static-Analysis"><a href="#Static-Analysis" class="headerlink" title="Static Analysis"></a>Static Analysis</h1><p>At first I tried using JADX again but failed…  </p>
<p><a href="/img/noverify/jadx_err.PNG"><a href="/img/noverify/jadx_err.PNG" title="jadx_err" class="gallery-item"><img src="/img/noverify/jadx_err.PNG" alt="jadx_err"></a></a>  </p>
<p>Then I used <a target="_blank" rel="noopener" href="https://bytecodeviewer.com/">Bytecode Viewer</a> and some of the decompilers it comes with but sadly those didn’t work too and I’d had to go with the bytecode.  </p>
<p>I’ll only dig up into some of the bytecode instructions, so if you are not quite experienced with JVM I’d recommend the following tutorials :<br><a target="_blank" rel="noopener" href="https://blog.jamesdbloom.com/JavaCodeToByteCode_PartOne.html">JavaCode To ByteCode - James D Bloom</a><br><a target="_blank" rel="noopener" href="https://youtu.be/e2zmmkc5xI0">Java Bytecode Crash Course - David Buck</a></p>
<p>Also, And as a reference for the JVM instruction set we have the following:<br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html">Oracle Java SE 7 Doc - The JVM Instruction Set</a><br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings">Wikipedia - Java Bytecode instruction Listings</a>  </p>
<p>I just copied the bytecode from Bytecode Viewer and started analysing it.  </p>
<p>It looks obfuscated but we can easily notice what is it doing …<br>For instance look at the following bytecode:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">L1 &#123;</span><br><span class="line">    aload0</span><br><span class="line">    arraylength</span><br><span class="line">    ldc <span class="number">1163059851</span> (java.lang.Integer)  </span><br><span class="line">    ldc <span class="number">1163059850</span> (java.lang.Integer)</span><br><span class="line">    swap</span><br><span class="line">    ixor	<span class="comment">// 1163059851 ^ 1163059850 = 1</span></span><br><span class="line">    if_icmpeq L34</span><br><span class="line">&#125;</span><br><span class="line">L37 &#123;</span><br><span class="line">    getstatic java/lang/System.out:java.io.PrintStream</span><br><span class="line">    ldc <span class="string">&quot;Welcome to noverify&#x27;s crackme! Please enter a numeric 64-bit key to play! The goal is to find a valid key!&quot;</span> (java.lang.String)</span><br><span class="line">    invokevirtual java/io/PrintStream.println(Ljava/lang/String;)V</span><br><span class="line">&#125;</span><br><span class="line">L38 &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This can be interpreted as the following pseudocode :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(args.length != <span class="number">1</span>) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Welcome to noverify\&#x27;s crackme! Please enter a numeric 64-bit key to play! The goal is to find a valid key!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And just after this we have what looks like a try-catch block.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">L34 &#123; <span class="comment">// try block</span></span><br><span class="line">    f_new (Locals[<span class="number">1</span>]: [Ljava/lang/String;) (Stack[<span class="number">0</span>]: <span class="keyword">null</span>)</span><br><span class="line">    aload0</span><br><span class="line">    ldc <span class="number">705718574</span> (java.lang.Integer)</span><br><span class="line">    dup</span><br><span class="line">    dup_x1</span><br><span class="line">    pop</span><br><span class="line">    ixor	<span class="comment">// 705718574 ^ 705718574 = 0</span></span><br><span class="line">    aaload</span><br><span class="line">    invokestatic java/lang/Long.parseLong(Ljava/lang/String;)J</span><br><span class="line">    lstore1</span><br><span class="line">&#125;</span><br><span class="line">L3 &#123; <span class="comment">// no exception</span></span><br><span class="line">    goto L5	<span class="comment">// continue execution</span></span><br><span class="line">&#125;</span><br><span class="line">L4 &#123; <span class="comment">//catch exception</span></span><br><span class="line">    f_new (Locals[<span class="number">1</span>]: [Ljava/lang/String;) (Stack[<span class="number">1</span>]: java/lang/Throwable)</span><br><span class="line">    astore3</span><br><span class="line">&#125;</span><br><span class="line">L6 &#123;</span><br><span class="line">    getstatic java/lang/System.out:java.io.PrintStream</span><br><span class="line">    ldc <span class="string">&quot;Invalid key!&quot;</span> (java.lang.String)</span><br><span class="line">    invokevirtual java/io/PrintStream.println(Ljava/lang/String;)V</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Could easily be converted to the following:  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    myinput = Long.parseLong(args[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(Throwable e) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Invalid key!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Actually I noticed quite a pattern with the xor instructions and wrote a short python script to just comment the result for it.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">bytecode =  <span class="built_in">open</span>(<span class="string">&#x27;noverify_bytecode.java&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repl1</span>(<span class="params">m</span>):</span></span><br><span class="line">    xor_res = <span class="built_in">int</span>(m.group(<span class="number">1</span>)) ^ <span class="built_in">int</span>(m.group(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> re.sub(<span class="string">r&quot;($)&quot;</span>, <span class="string">&quot;// &quot;</span>+ m.group(<span class="number">1</span>) + <span class="string">&quot; ^ &quot;</span>\</span><br><span class="line">            + m.group(<span class="number">2</span>) + <span class="string">&quot; = [&quot;</span> + <span class="built_in">str</span>(xor_res) + <span class="string">&quot;]&quot;</span>+ <span class="string">&quot;\n\t\t\t &quot;</span>\</span><br><span class="line">            , m.group())</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">repl2</span>(<span class="params">m</span>):</span></span><br><span class="line">    <span class="keyword">return</span> re.sub(<span class="string">r&quot;($)&quot;</span>, <span class="string">&quot;// &quot;</span>+ m.group(<span class="number">1</span>) + <span class="string">&quot; ^ &quot;</span> \</span><br><span class="line">            + m.group(<span class="number">1</span>) + <span class="string">&quot; = [0]&quot;</span> + <span class="string">&quot;\n\t\t\t &quot;</span>\</span><br><span class="line">            , m.group())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">regex1 = <span class="string">r&quot; &#123;13&#125;ldc (.*) \(java\.lang\.Integer\)\n&quot;</span> \</span><br><span class="line">            +<span class="string">&quot; &#123;13&#125;ldc (.*) \(java\.lang\.Integer\)\n &#123;13&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">regex2 = <span class="string">r&quot; &#123;13&#125;ldc (.*) \(java\.lang\.Integer\)\n &#123;13&#125;dup\n &#123;13&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">got1 = re.sub(regex1, repl1, bytecode)</span><br><span class="line">got2 = re.sub(regex2, repl2, got1)</span><br><span class="line"></span><br><span class="line">out = <span class="built_in">open</span>(<span class="string">&#x27;formatted_bytecode.java&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">out.write(got2)</span><br><span class="line">out.close()</span><br></pre></td></tr></table></figure>
<p>The first regex searches for two consecutive <strong><code>ldc</code></strong> instruction on Integers.<br>And the latter one just checks for one <strong><code>ldc</code></strong> and other <strong><code>dup</code></strong> which always results in 0.<br>The result of these xors is used as predefined integers in the program.<br>And after some such xors we find some Congratulations and sorry strings which leads us to the checking instruction that makes use of one of the methods ie. <em><code>method 0</code></em> and passes an array to it as an argument.  </p>
<p><a href="/img/noverify/method_call_0.PNG"><a href="/img/noverify/method_call_0.PNG" title="method_call_0" class="gallery-item"><img src="/img/noverify/method_call_0.PNG" alt="method_call_0"></a></a>  </p>
<p>Tracing back to the array initialisation I found that there were actually two arrays :  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">L5 &#123;</span><br><span class="line">    f_new (Locals[<span class="number">2</span>]: [Ljava/lang/String;, <span class="number">4</span>) (Stack[<span class="number">0</span>]: <span class="keyword">null</span>)</span><br><span class="line">    ldc -<span class="number">1563720133</span> (java.lang.Integer)</span><br><span class="line">    ldc -<span class="number">1563720130</span> (java.lang.Integer)</span><br><span class="line">    <span class="comment">// -1563720133 ^ -1563720130 = [5]</span></span><br><span class="line">    swap</span><br><span class="line">    ixor</span><br><span class="line">    newarray <span class="number">8</span>  <span class="comment">//arr1[5]</span></span><br><span class="line">    astore3</span><br><span class="line">&#125;</span><br><span class="line">L7 &#123;</span><br><span class="line">    ldc -<span class="number">2143046895</span> (java.lang.Integer)</span><br><span class="line">    ldc -<span class="number">2143046894</span> (java.lang.Integer)</span><br><span class="line">    <span class="comment">// -2143046895 ^ -2143046894 = [3]</span></span><br><span class="line">    swap</span><br><span class="line">    ixor</span><br><span class="line">    newarray <span class="number">8</span>  <span class="comment">//arr2[3]</span></span><br><span class="line">    astore4</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Taking help from the instruction set manual we see that they are both byte arrays.  </p>
<p><a href="/img/noverify/arr_type_codes.PNG"><a href="/img/noverify/arr_type_codes.PNG" title="arr_type_codes" class="gallery-item"><img src="/img/noverify/arr_type_codes.PNG" alt="arr_type_codes"></a></a>  </p>
<p>Subsequently we observe <strong><code>bastore</code></strong> in every label below which does some calculations and store the result in these bytearrays.<br>So only the array with length as 3 is passed and which depends on our input.<br>Then we can see that there are several methods named numerically other than 0 and I explored them the other day.  </p>
<h2 id="Indy-in-Action"><a href="#Indy-in-Action" class="headerlink" title="Indy in Action"></a>Indy in Action</h2><p>Continuing further it is important we understand about invokedynamic.<br>We can easily observe the InvokeDynamic instruction at the return of every other method other than main.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">invokedynamic me/nov/crackme/CrackMe<span class="number">.127</span>([Ljava/lang/Object;)Ljava/lang/Object; : <span class="number">64</span>([Ljava/lang/Object;)Ljava/lang/Object; ([Ljava/lang/Object;)Ljava/lang/Object;</span><br><span class="line">areturn</span><br></pre></td></tr></table></figure>
<p>The invokedynamic (or simply Indy) is used for optimization and creating efficient java programs and implements a runtime system that can choose the most appropriate implementation of a method or function after the program has been compiled.</p>
<p><a target="_blank" rel="noopener" href="https://www.infoworld.com/article/2860079/invokedynamic-101.html">InvokeDynamic 101</a><br><a target="_blank" rel="noopener" href="https://youtu.be/KhiECfzyVt0">InvokeDynamic for Mere Mortals</a><br>Also checkout how are lambdas in java implemented with making use of invokedynamic <a target="_blank" rel="noopener" href="https://youtu.be/MLksirK9nnE">here</a>  </p>
<p>For examples we have the following implementations :  </p>
<ul>
<li>Lambda Expressions in Java 8+: <code>LambdaMetafactory</code></li>
<li>String Concatenation in Java 9+: <code>StringConcatFactory</code></li>
</ul>
<p>For instance, in newer versions of Java, String Concatenation is not done by appending the string elements multiple times using StringBuilder append function, instead it places those in an array and makes use of invokedynamic and StringConcatFactory to have a single method call.  </p>
<p>Furthering researching about the topic I came across this post by the official JEB blog.<br><a target="_blank" rel="noopener" href="https://www.pnfsoftware.com/blog/android-o-and-dex-version-38-new-dalvik-opcodes-to-support-dynamic-invocation/">https://www.pnfsoftware.com/blog/android-o-and-dex-version-38-new-dalvik-opcodes-to-support-dynamic-invocation/</a>  </p>
<p>And I thought to give <a target="_blank" rel="noopener" href="https://www.pnfsoftware.com/">JEB Pro</a> a try to see how well it handles it. Apart from some ambiguous variable names all is fine.  </p>
<p>So basically for indy there is a bootStrap method that creates a callsite which points to a handle to a predefined method.  </p>
<p>Here <strong><code>127</code></strong> looks like the bootstrap method!  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="number">127</span>(Object[] arg8) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">char</span> v3 = (<span class="keyword">char</span>)((Thread.currentThread().getStackTrace()[<span class="number">2</span>].getMethodName().hashCode() * arg8[<span class="number">0</span>].toString().hashCode() * <span class="number">32767</span> &lt;&lt; <span class="number">3</span> | <span class="number">127</span>) &amp; <span class="number">127</span>);</span><br><span class="line">        <span class="keyword">if</span>(Thread.currentThread().getStackTrace().length &gt; <span class="number">127</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> v3 &gt; <span class="number">127</span> ? Boolean.valueOf(<span class="keyword">false</span>) : Boolean.valueOf(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MutableCallSite(((MethodHandles.Lookup)arg8[<span class="number">0</span>]).findStatic(CrackMe.class, String.valueOf(CrackMe.fun), ((MethodType)arg8[<span class="number">3</span>])));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(Throwable unused_ex) &#123;</span><br><span class="line">        <span class="keyword">return</span> CrackMe<span class="number">.0</span>(<span class="keyword">new</span> Object[]&#123;arg8[<span class="number">3</span>].toString()&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Basically, it returns a callsite which points to a method handle it finds when searching for a static method with the value of fun in the class Crackme.  </p>
<p>Reference - <a target="_blank" rel="noopener" href="https://developer.android.com/reference/java/lang/invoke/MutableCallSite">MutableCallSite</a></p>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="number">0</span>(Object[] arg5) &#123;</span><br><span class="line">    <span class="keyword">char</span> v5 = (<span class="keyword">char</span>)((Thread.currentThread().getStackTrace()[<span class="number">2</span>].getMethodName().hashCode() * Integer.parseInt(arg5[<span class="number">0</span>].toString()) * <span class="number">32767</span> &lt;&lt; <span class="number">3</span> | <span class="number">127</span>) &amp; <span class="number">65535</span>);</span><br><span class="line">    <span class="keyword">if</span>(Thread.currentThread().getStackTrace().length &gt; <span class="number">127</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> v5 &gt;= <span class="number">127</span> ? Boolean.valueOf(<span class="keyword">false</span>) : Boolean.valueOf(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CrackMe.fun = <span class="keyword">new</span> String(<span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;v5&#125;).getBytes(StandardCharsets.UTF_8), StandardCharsets.UTF_8).charAt(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> InvokeCustoms.CallSite0_64(<span class="keyword">new</span> Object[]&#123;((<span class="keyword">int</span>)(v5 ^ <span class="number">64</span>))&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It converts the string passed as an array to a 3 digit integer and does the following operation on it.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(( get_hashcode(callee_fcn) * arg) * <span class="number">0x7FFF</span> &lt;&lt; <span class="number">3</span> | <span class="number">127</span>) &amp; <span class="number">0xFFFF</span>  </span><br></pre></td></tr></table></figure>
<p>So, It monitors the execution flow and depends on the callee function. And later converts it to a utf-8 string and stores it into a static variable <strong><code>fun</code></strong>.<br>It passes the integer result xored with a specific value as an argument to the method called as a result of invokedynamic.  </p>
<p>All the other methods are mostly similar to this except that they differ in this xor operand value.<br>For extracting those, we can just use a simple regex. Also for 127 we can just fake it with a 0.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">filedata = <span class="built_in">open</span>(<span class="string">&quot;jeb_decompiled_code.java&quot;</span>).read().split(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">desired_lines1, desired_lines2 = filedata[<span class="number">0</span>::<span class="number">10</span>], filedata[<span class="number">7</span>::<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x,y <span class="keyword">in</span> <span class="built_in">zip</span>(desired_lines1, desired_lines2):</span><br><span class="line">    x = re.search(<span class="string">r&quot;Object (.*)\(Object&quot;</span>, x).group(<span class="number">1</span>)</span><br><span class="line">    y = re.search(<span class="string">r&quot;\(new Object\[\]\&#123;\(\(int\)\(v5 \^ (.*)\)\)\&#125;\);&quot;</span>, y).group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;0x&#x27;</span> <span class="keyword">in</span> y:</span><br><span class="line">        y = <span class="built_in">int</span>(y,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span> x,<span class="string">&quot;:&quot;</span>,y</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Thread.currentThread().getStackTrace().length &gt; <span class="number">127</span>)</span><br></pre></td></tr></table></figure>
<p>We see that it checks if the no. of functions executed in a run is greater than 127 it returns true which should then validate out input.<br>Perfect this is all we need to know to write a short python script.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">nice_fcns = [<span class="number">0</span>,<span class="number">63</span>,<span class="number">127</span>,<span class="number">255</span>,<span class="number">462</span>,<span class="number">740</span>,<span class="number">896</span>,<span class="number">1217</span>,<span class="number">1721</span>,<span class="number">1914</span>,<span class="number">2457</span>,<span class="number">2697</span>,<span class="number">3300</span>,<span class="number">3994</span>,<span class="number">4535</span>,<span class="number">4647</span>,<span class="number">5078</span>,<span class="number">5256</span>,<span class="number">5311</span>,<span class="number">5594</span>,<span class="number">5680</span>,<span class="number">5751</span>,<span class="number">6139</span>,<span class="number">6273</span>,<span class="number">6544</span>,<span class="number">6640</span>,<span class="number">6740</span>,<span class="number">6866</span>,<span class="number">6956</span>,<span class="number">7039</span>,<span class="number">7127</span>,<span class="number">7205</span>,<span class="number">7334</span>,<span class="number">8392</span>,<span class="number">8489</span>,<span class="number">8591</span>,<span class="number">8963</span>,<span class="number">9828</span>,<span class="number">10245</span>,<span class="number">10310</span>,<span class="number">10359</span>,<span class="number">11024</span>,<span class="number">11208</span>,<span class="number">11394</span>,<span class="number">11775</span>,<span class="number">12009</span>,<span class="number">12071</span>,<span class="number">12505</span>,<span class="number">12531</span>,<span class="number">12689</span>,<span class="number">13158</span>,<span class="number">13529</span>,<span class="number">13910</span>,<span class="number">13946</span>,<span class="number">14071</span>,<span class="number">14256</span>,<span class="number">14643</span>,<span class="number">14981</span>,<span class="number">15004</span>,<span class="number">15021</span>,<span class="number">15170</span>,<span class="number">15725</span>,<span class="number">15889</span>,<span class="number">15903</span>,<span class="number">15999</span>,<span class="number">16632</span>,<span class="number">17038</span>,<span class="number">17270</span>,<span class="number">17362</span>,<span class="number">17470</span>,<span class="number">17594</span>,<span class="number">18318</span>,<span class="number">18415</span>,<span class="number">18642</span>,<span class="number">18809</span>,<span class="number">18943</span>,<span class="number">19300</span>,<span class="number">19493</span>,<span class="number">19699</span>,<span class="number">19813</span>,<span class="number">20069</span>,<span class="number">20753</span>,<span class="number">21238</span>,<span class="number">21380</span>,<span class="number">21522</span>,<span class="number">21855</span>,<span class="number">21867</span>,<span class="number">22095</span>,<span class="number">22909</span>,<span class="number">22966</span>,<span class="number">23046</span>,<span class="number">23167</span>,<span class="number">23469</span>,<span class="number">23651</span>,<span class="number">23762</span>,<span class="number">23979</span>,<span class="number">24112</span>,<span class="number">24303</span>,<span class="number">24352</span>,<span class="number">24395</span>,<span class="number">24440</span>,<span class="number">25087</span>,<span class="number">25167</span>,<span class="number">25366</span>,<span class="number">25592</span>,<span class="number">25895</span>,<span class="number">26142</span>,<span class="number">26206</span>,<span class="number">26442</span>,<span class="number">26746</span>,<span class="number">27153</span>,<span class="number">27647</span>,<span class="number">27728</span>,<span class="number">27903</span>,<span class="number">28356</span>,<span class="number">28537</span>,<span class="number">29070</span>,<span class="number">29177</span>,<span class="number">29329</span>,<span class="number">29648</span>,<span class="number">29760</span>,<span class="number">30695</span>,<span class="number">30827</span>,<span class="number">31246</span>,<span class="number">31314</span>,<span class="number">31533</span>,<span class="number">31709</span>,<span class="number">31797</span>,<span class="number">32014</span>,<span class="number">32263</span>,<span class="number">32384</span>,<span class="number">32681</span>,<span class="number">32815</span>,<span class="number">32896</span>,<span class="number">32937</span>,<span class="number">33201</span>,<span class="number">33323</span>,<span class="number">33467</span>,<span class="number">33511</span>,<span class="number">34315</span>,<span class="number">34374</span>,<span class="number">35511</span>,<span class="number">35812</span>,<span class="number">36141</span>,<span class="number">36234</span>,<span class="number">36256</span>,<span class="number">36382</span>,<span class="number">36556</span>,<span class="number">37137</span>,<span class="number">37298</span>,<span class="number">37790</span>,<span class="number">37918</span>,<span class="number">37995</span>,<span class="number">38143</span>,<span class="number">38435</span>,<span class="number">38867</span>,<span class="number">38940</span>,<span class="number">38974</span>,<span class="number">39041</span>,<span class="number">39108</span>,<span class="number">39166</span>,<span class="number">39309</span>,<span class="number">40355</span>,<span class="number">40726</span>,<span class="number">40791</span>,<span class="number">40986</span>,<span class="number">41166</span>,<span class="number">41503</span>,<span class="number">42447</span>,<span class="number">42534</span>,<span class="number">42704</span>,<span class="number">43135</span>,<span class="number">43263</span>,<span class="number">43521</span>,<span class="number">43557</span>,<span class="number">43730</span>,<span class="number">43779</span>,<span class="number">44178</span>,<span class="number">44677</span>,<span class="number">44734</span>,<span class="number">44797</span>,<span class="number">44943</span>,<span class="number">45007</span>,<span class="number">45966</span>,<span class="number">46337</span>,<span class="number">46396</span>,<span class="number">46528</span>,<span class="number">46979</span>,<span class="number">47000</span>,<span class="number">47533</span>,<span class="number">47846</span>,<span class="number">47921</span>,<span class="number">47948</span>,<span class="number">48207</span>,<span class="number">48557</span>,<span class="number">48726</span>,<span class="number">48975</span>,<span class="number">48996</span>,<span class="number">49636</span>,<span class="number">49667</span>,<span class="number">50383</span>,<span class="number">51030</span>,<span class="number">51358</span>,<span class="number">51578</span>,<span class="number">51583</span>,<span class="number">51692</span>,<span class="number">51702</span>,<span class="number">52032</span>,<span class="number">52101</span>,<span class="number">52184</span>,<span class="number">52396</span>,<span class="number">52500</span>,<span class="number">52530</span>,<span class="number">52538</span>,<span class="number">52556</span>,<span class="number">52931</span>,<span class="number">53184</span>,<span class="number">53275</span>,<span class="number">53324</span>,<span class="number">53564</span>,<span class="number">53774</span>,<span class="number">53887</span>,<span class="number">54212</span>,<span class="number">54764</span>,<span class="number">55039</span>,<span class="number">55295</span>,<span class="number">55342</span>,<span class="number">55359</span>,<span class="number">55375</span>,<span class="number">55774</span>,<span class="number">55938</span>,<span class="number">56138</span>,<span class="number">56452</span>,<span class="number">56564</span>,<span class="number">56816</span>,<span class="number">57016</span>,<span class="number">57107</span>,<span class="number">57508</span>,<span class="number">57569</span>,<span class="number">57611</span>,<span class="number">57779</span>,<span class="number">57796</span>,<span class="number">58153</span>,<span class="number">59099</span>,<span class="number">59380</span>,<span class="number">59406</span>,<span class="number">59575</span>,<span class="number">59829</span>,<span class="number">59875</span>,<span class="number">60282</span>,<span class="number">60756</span>,<span class="number">61041</span>,<span class="number">61087</span>,<span class="number">61428</span>,<span class="number">61495</span>,<span class="number">61565</span>,<span class="number">61664</span>,<span class="number">61703</span>,<span class="number">61839</span>,<span class="number">62288</span>,<span class="number">62561</span>,<span class="number">62614</span>,<span class="number">62719</span>,<span class="number">62991</span>,<span class="number">63231</span>,<span class="number">63256</span>,<span class="number">63670</span>,<span class="number">63882</span>,<span class="number">64009</span>,<span class="number">64051</span>,<span class="number">64127</span>,<span class="number">64191</span>,<span class="number">64625</span>,<span class="number">64934</span>,<span class="number">65018</span>,<span class="number">65155</span>,]</span><br><span class="line">xor_values_map = &#123;<span class="number">0</span> : <span class="number">64</span>, <span class="number">10245</span> : <span class="number">48</span>, <span class="number">10310</span> : <span class="number">244</span>, <span class="number">10359</span> : <span class="number">160</span>, <span class="number">11024</span> : <span class="number">56</span>, <span class="number">11208</span> : <span class="number">24</span>, <span class="number">11394</span> : <span class="number">200</span>, <span class="number">11775</span> : <span class="number">236</span>, <span class="number">12009</span> : <span class="number">32</span>, <span class="number">12071</span> : <span class="number">156</span>, <span class="number">1217</span> : <span class="number">36</span>, <span class="number">12505</span> : <span class="number">220</span>, <span class="number">12531</span> : <span class="number">56</span>, <span class="number">12689</span> : <span class="number">168</span>, <span class="number">127</span> : <span class="number">0</span>, <span class="number">13158</span> : <span class="number">184</span>, <span class="number">13529</span> : <span class="number">24</span>, <span class="number">13910</span> : <span class="number">168</span>, <span class="number">13946</span> : <span class="number">92</span>, <span class="number">14071</span> : <span class="number">36</span>, <span class="number">14256</span> : <span class="number">192</span>, <span class="number">14643</span> : <span class="number">184</span>, <span class="number">14981</span> : <span class="number">132</span>, <span class="number">15004</span> : <span class="number">192</span>, <span class="number">15021</span> : <span class="number">20</span>, <span class="number">15170</span> : <span class="number">232</span>, <span class="number">15725</span> : <span class="number">40</span>, <span class="number">15889</span> : <span class="number">108</span>, <span class="number">15903</span> : <span class="number">160</span>, <span class="number">15999</span> : <span class="number">236</span>, <span class="number">16632</span> : <span class="number">192</span>, <span class="number">17038</span> : <span class="number">132</span>, <span class="number">1721</span> : <span class="number">44</span>, <span class="number">17270</span> : <span class="number">44</span>, <span class="number">17362</span> : <span class="number">156</span>, <span class="number">17470</span> : <span class="number">164</span>, <span class="number">17594</span> : <span class="number">216</span>, <span class="number">18318</span> : <span class="number">244</span>, <span class="number">18415</span> : <span class="number">124</span>, <span class="number">18642</span> : <span class="number">12</span>, <span class="number">18809</span> : <span class="number">152</span>, <span class="number">18943</span> : <span class="number">252</span>, <span class="number">1914</span> : <span class="number">20</span>, <span class="number">19300</span> : <span class="number">20</span>, <span class="number">19493</span> : <span class="number">232</span>, <span class="number">19699</span> : <span class="number">200</span>, <span class="number">19813</span> : <span class="number">184</span>, <span class="number">20069</span> : <span class="number">236</span>, <span class="number">20753</span> : <span class="number">228</span>, <span class="number">21238</span> : <span class="number">32</span>, <span class="number">21380</span> : <span class="number">208</span>, <span class="number">21522</span> : <span class="number">40</span>, <span class="number">21855</span> : <span class="number">220</span>, <span class="number">21867</span> : <span class="number">24</span>, <span class="number">22095</span> : <span class="number">208</span>, <span class="number">22909</span> : <span class="number">120</span>, <span class="number">22966</span> : <span class="number">220</span>, <span class="number">23046</span> : <span class="number">124</span>, <span class="number">23167</span> : <span class="number">124</span>, <span class="number">23469</span> : <span class="number">40</span>, <span class="number">23651</span> : <span class="number">252</span>, <span class="number">23762</span> : <span class="number">56</span>, <span class="number">23979</span> : <span class="number">152</span>, <span class="number">24112</span> : <span class="number">192</span>, <span class="number">24303</span> : <span class="number">48</span>, <span class="number">24352</span> : <span class="number">72</span>, <span class="number">24395</span> : <span class="number">140</span>, <span class="number">24440</span> : <span class="number">200</span>, <span class="number">2457</span> : <span class="number">112</span>, <span class="number">25087</span> : <span class="number">208</span>, <span class="number">25167</span> : <span class="number">4</span>, <span class="number">25366</span> : <span class="number">192</span>, <span class="number">255</span> : <span class="number">56</span>, <span class="number">25592</span> : <span class="number">148</span>, <span class="number">25895</span> : <span class="number">252</span>, <span class="number">26142</span> : <span class="number">148</span>, <span class="number">26206</span> : <span class="number">48</span>, <span class="number">26442</span> : <span class="number">200</span>, <span class="number">26746</span> : <span class="number">236</span>, <span class="number">2697</span> : <span class="number">248</span>, <span class="number">27153</span> : <span class="number">216</span>, <span class="number">27647</span> : <span class="number">176</span>, <span class="number">27728</span> : <span class="number">160</span>, <span class="number">27903</span> : <span class="number">228</span>, <span class="number">28356</span> : <span class="number">72</span>, <span class="number">28537</span> : <span class="number">244</span>, <span class="number">29070</span> : <span class="number">248</span>, <span class="number">29177</span> : <span class="number">216</span>, <span class="number">29329</span> : <span class="number">244</span>, <span class="number">29648</span> : <span class="number">244</span>, <span class="number">29760</span> : <span class="number">88</span>, <span class="number">30695</span> : <span class="number">108</span>, <span class="number">30827</span> : <span class="number">0</span>, <span class="number">31246</span> : <span class="number">40</span>, <span class="number">31314</span> : <span class="number">32</span>, <span class="number">31533</span> : <span class="number">100</span>, <span class="number">31709</span> : <span class="number">248</span>, <span class="number">31797</span> : <span class="number">100</span>, <span class="number">32014</span> : <span class="number">176</span>, <span class="number">32263</span> : <span class="number">64</span>, <span class="number">32384</span> : <span class="number">64</span>, <span class="number">32681</span> : <span class="number">64</span>, <span class="number">32815</span> : <span class="number">76</span>, <span class="number">32896</span> : <span class="number">40</span>, <span class="number">32937</span> : <span class="number">8</span>, <span class="number">3300</span> : <span class="number">128</span>, <span class="number">33201</span> : <span class="number">244</span>, <span class="number">33323</span> : <span class="number">176</span>, <span class="number">33467</span> : <span class="number">108</span>, <span class="number">33511</span> : <span class="number">236</span>, <span class="number">34315</span> : <span class="number">40</span>, <span class="number">34374</span> : <span class="number">4</span>, <span class="number">35511</span> : <span class="number">116</span>, <span class="number">35812</span> : <span class="number">100</span>, <span class="number">36141</span> : <span class="number">148</span>, <span class="number">36234</span> : <span class="number">192</span>, <span class="number">36256</span> : <span class="number">192</span>, <span class="number">36382</span> : <span class="number">216</span>, <span class="number">36556</span> : <span class="number">244</span>, <span class="number">37137</span> : <span class="number">252</span>, <span class="number">37298</span> : <span class="number">12</span>, <span class="number">37790</span> : <span class="number">216</span>, <span class="number">37918</span> : <span class="number">16</span>, <span class="number">37995</span> : <span class="number">252</span>, <span class="number">38143</span> : <span class="number">148</span>, <span class="number">38435</span> : <span class="number">124</span>, <span class="number">38867</span> : <span class="number">48</span>, <span class="number">38940</span> : <span class="number">64</span>, <span class="number">38974</span> : <span class="number">124</span>, <span class="number">39041</span> : <span class="number">36</span>, <span class="number">39108</span> : <span class="number">244</span>, <span class="number">39166</span> : <span class="number">20</span>, <span class="number">39309</span> : <span class="number">40</span>, <span class="number">3994</span> : <span class="number">188</span>, <span class="number">40355</span> : <span class="number">228</span>, <span class="number">40726</span> : <span class="number">68</span>, <span class="number">40791</span> : <span class="number">244</span>, <span class="number">40986</span> : <span class="number">84</span>, <span class="number">41166</span> : <span class="number">176</span>, <span class="number">41503</span> : <span class="number">212</span>, <span class="number">42447</span> : <span class="number">220</span>, <span class="number">42534</span> : <span class="number">160</span>, <span class="number">42704</span> : <span class="number">204</span>, <span class="number">43135</span> : <span class="number">48</span>, <span class="number">43263</span> : <span class="number">192</span>, <span class="number">43521</span> : <span class="number">108</span>, <span class="number">43557</span> : <span class="number">32</span>, <span class="number">43730</span> : <span class="number">236</span>, <span class="number">43779</span> : <span class="number">152</span>, <span class="number">44178</span> : <span class="number">56</span>, <span class="number">44677</span> : <span class="number">40</span>, <span class="number">44734</span> : <span class="number">160</span>, <span class="number">44797</span> : <span class="number">108</span>, <span class="number">44943</span> : <span class="number">32</span>, <span class="number">45007</span> : <span class="number">40</span>, <span class="number">4535</span> : <span class="number">180</span>, <span class="number">45966</span> : <span class="number">160</span>, <span class="number">462</span> : <span class="number">64</span>, <span class="number">46337</span> : <span class="number">108</span>, <span class="number">46396</span> : <span class="number">72</span>, <span class="number">4647</span> : <span class="number">172</span>, <span class="number">46528</span> : <span class="number">220</span>, <span class="number">46979</span> : <span class="number">92</span>, <span class="number">47000</span> : <span class="number">140</span>, <span class="number">47533</span> : <span class="number">184</span>, <span class="number">47846</span> : <span class="number">228</span>, <span class="number">47921</span> : <span class="number">108</span>, <span class="number">47948</span> : <span class="number">24</span>, <span class="number">48207</span> : <span class="number">236</span>, <span class="number">48557</span> : <span class="number">244</span>, <span class="number">48726</span> : <span class="number">100</span>, <span class="number">48975</span> : <span class="number">244</span>, <span class="number">48996</span> : <span class="number">56</span>, <span class="number">49636</span> : <span class="number">48</span>, <span class="number">49667</span> : <span class="number">56</span>, <span class="number">50383</span> : <span class="number">116</span>, <span class="number">5078</span> : <span class="number">16</span>, <span class="number">51030</span> : <span class="number">252</span>, <span class="number">51358</span> : <span class="number">152</span>, <span class="number">51578</span> : <span class="number">152</span>, <span class="number">51583</span> : <span class="number">176</span>, <span class="number">51692</span> : <span class="number">116</span>, <span class="number">51702</span> : <span class="number">76</span>, <span class="number">52032</span> : <span class="number">56</span>, <span class="number">52101</span> : <span class="number">236</span>, <span class="number">52184</span> : <span class="number">64</span>, <span class="number">52396</span> : <span class="number">244</span>, <span class="number">52500</span> : <span class="number">32</span>, <span class="number">52530</span> : <span class="number">108</span>, <span class="number">52538</span> : <span class="number">76</span>, <span class="number">52556</span> : <span class="number">92</span>, <span class="number">5256</span> : <span class="number">136</span>, <span class="number">52931</span> : <span class="number">24</span>, <span class="number">5311</span> : <span class="number">136</span>, <span class="number">53184</span> : <span class="number">4</span>, <span class="number">53275</span> : <span class="number">184</span>, <span class="number">53324</span> : <span class="number">228</span>, <span class="number">53564</span> : <span class="number">108</span>, <span class="number">53774</span> : <span class="number">168</span>, <span class="number">53887</span> : <span class="number">92</span>, <span class="number">54212</span> : <span class="number">176</span>, <span class="number">54764</span> : <span class="number">168</span>, <span class="number">55039</span> : <span class="number">168</span>, <span class="number">55295</span> : <span class="number">200</span>, <span class="number">55342</span> : <span class="number">124</span>, <span class="number">55359</span> : <span class="number">100</span>, <span class="number">55375</span> : <span class="number">252</span>, <span class="number">55774</span> : <span class="number">48</span>, <span class="number">55938</span> : <span class="number">136</span>, <span class="number">5594</span> : <span class="number">84</span>, <span class="number">56138</span> : <span class="number">108</span>, <span class="number">56452</span> : <span class="number">192</span>, <span class="number">56564</span> : <span class="number">184</span>, <span class="number">5680</span> : <span class="number">92</span>, <span class="number">56816</span> : <span class="number">144</span>, <span class="number">57016</span> : <span class="number">116</span>, <span class="number">57107</span> : <span class="number">40</span>, <span class="number">57508</span> : <span class="number">212</span>, <span class="number">5751</span> : <span class="number">136</span>, <span class="number">57569</span> : <span class="number">40</span>, <span class="number">57611</span> : <span class="number">48</span>, <span class="number">57779</span> : <span class="number">100</span>, <span class="number">57796</span> : <span class="number">184</span>, <span class="number">58153</span> : <span class="number">208</span>, <span class="number">59099</span> : <span class="number">80</span>, <span class="number">59380</span> : <span class="number">36</span>, <span class="number">59406</span> : <span class="number">40</span>, <span class="number">59575</span> : <span class="number">132</span>, <span class="number">59829</span> : <span class="number">212</span>, <span class="number">59875</span> : <span class="number">184</span>, <span class="number">60282</span> : <span class="number">184</span>, <span class="number">60756</span> : <span class="number">8</span>, <span class="number">61041</span> : <span class="number">56</span>, <span class="number">61087</span> : <span class="number">176</span>, <span class="number">6139</span> : <span class="number">60</span>, <span class="number">61428</span> : <span class="number">196</span>, <span class="number">61495</span> : <span class="number">236</span>, <span class="number">61565</span> : <span class="number">92</span>, <span class="number">61664</span> : <span class="number">92</span>, <span class="number">61703</span> : <span class="number">196</span>, <span class="number">61839</span> : <span class="number">52</span>, <span class="number">62288</span> : <span class="number">168</span>, <span class="number">62561</span> : <span class="number">48</span>, <span class="number">62614</span> : <span class="number">76</span>, <span class="number">62719</span> : <span class="number">180</span>, <span class="number">6273</span> : <span class="number">160</span>, <span class="number">62991</span> : <span class="number">108</span>, <span class="number">63</span> : <span class="number">204</span>, <span class="number">63231</span> : <span class="number">116</span>, <span class="number">63256</span> : <span class="number">168</span>, <span class="number">63670</span> : <span class="number">184</span>, <span class="number">63882</span> : <span class="number">108</span>, <span class="number">64009</span> : <span class="number">84</span>, <span class="number">64051</span> : <span class="number">72</span>, <span class="number">64127</span> : <span class="number">32</span>, <span class="number">64191</span> : <span class="number">20</span>, <span class="number">64625</span> : <span class="number">84</span>, <span class="number">64934</span> : <span class="number">144</span>, <span class="number">65018</span> : <span class="number">32</span>, <span class="number">65155</span> : <span class="number">184</span>, <span class="number">6544</span> : <span class="number">68</span>, <span class="number">6640</span> : <span class="number">16</span>, <span class="number">6740</span> : <span class="number">204</span>, <span class="number">6866</span> : <span class="number">120</span>, <span class="number">6956</span> : <span class="number">112</span>, <span class="number">7039</span> : <span class="number">68</span>, <span class="number">7127</span> : <span class="number">196</span>, <span class="number">7205</span> : <span class="number">128</span>, <span class="number">7334</span> : <span class="number">204</span>, <span class="number">740</span> : <span class="number">116</span>, <span class="number">8392</span> : <span class="number">176</span>, <span class="number">8489</span> : <span class="number">204</span>, <span class="number">8591</span> : <span class="number">108</span>, <span class="number">896</span> : <span class="number">108</span>, <span class="number">8963</span> : <span class="number">136</span>, <span class="number">9828</span> : <span class="number">44</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_hashcode</span>(<span class="params">s</span>):</span></span><br><span class="line">    s = <span class="built_in">str</span>(s)</span><br><span class="line">    n = <span class="built_in">len</span>(s)</span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        res += <span class="built_in">ord</span>(s[i])*<span class="number">31</span>**(n-(i+<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    visited = [<span class="number">0</span>]</span><br><span class="line">    <span class="comment">#init with call to fcn_0</span></span><br><span class="line">    v5 = (( get_hashcode(<span class="string">&#x27;main&#x27;</span>) * arg) * <span class="number">0x7FFF</span> &lt;&lt; <span class="number">3</span> | <span class="number">127</span>) &amp; <span class="number">0xFFFF</span></span><br><span class="line">    <span class="keyword">if</span> v5 <span class="keyword">in</span> nice_fcns:</span><br><span class="line">        <span class="built_in">print</span> arg,<span class="string">&quot;: END @&quot;</span>,</span><br><span class="line">        visited.append(v5)</span><br><span class="line">        arg = v5 ^ xor_values_map[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">#print &quot;Not eligible !!&quot;</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        v5 = (( get_hashcode(visited[-<span class="number">2</span>]) * arg) * <span class="number">0x7FFF</span> &lt;&lt; <span class="number">3</span> | <span class="number">127</span>) &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> v5 <span class="keyword">in</span> nice_fcns:</span><br><span class="line">            arg = v5 ^ xor_values_map[visited[-<span class="number">1</span>]]</span><br><span class="line">            visited.append(v5)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span> v5</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;len(stackTrace) = &quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(visited)+<span class="number">2</span>),visited)</span><br></pre></td></tr></table></figure>
<p>Here we check for maximum length of stacktrace which can be achieved and to my surprise it was 22!<br>Also there are 3 results(191,465,739) with the same stacktrace which ends at 7039.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">&#x27;len(stackTrace) = 22&#x27;</span>, [<span class="number">0</span>, <span class="number">55295L</span>, <span class="number">25087L</span>, <span class="number">255L</span>, <span class="number">15999L</span>, <span class="number">64127L</span>, <span class="number">63231L</span>, <span class="number">11775L</span>, <span class="number">23167L</span>, <span class="number">62719L</span>, <span class="number">43135L</span>, <span class="number">27647L</span>, <span class="number">18943L</span>, <span class="number">38143L</span>, <span class="number">51583L</span>, <span class="number">53887L</span>, <span class="number">27903L</span>, <span class="number">55039L</span>, <span class="number">43263L</span>, <span class="number">7039L</span>])</span><br></pre></td></tr></table></figure>

<p>Then I moved on and wrote used z3 to find the exact 64 bit integer which results in those 3 digit values. Note the operations on the input.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line">inp = BitVec(<span class="string">&#x27;inp&#x27;</span>,<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">res1 = ((inp &gt;&gt; <span class="number">24</span> &amp; <span class="number">15</span> | (inp &gt;&gt; <span class="number">56</span> &amp; <span class="number">15</span>) &lt;&lt; <span class="number">4</span>)&amp; <span class="number">0xFF</span>)</span><br><span class="line">res2 = ((inp &gt;&gt; <span class="number">8</span> &amp; <span class="number">15</span> | (inp &gt;&gt; <span class="number">40</span> &amp; <span class="number">15</span>) &lt;&lt; <span class="number">4</span>)&amp; <span class="number">0xFF</span>)</span><br><span class="line">res3 = ((inp &gt;&gt; <span class="number">0</span> &amp; <span class="number">15</span> | (inp &gt;&gt; <span class="number">0x20</span> &amp; <span class="number">15</span>) &lt;&lt; <span class="number">4</span>)&amp; <span class="number">0xFF</span>)</span><br><span class="line"></span><br><span class="line">s.add(And(res1 &gt;= <span class="number">48</span>,res1 &lt;= <span class="number">57</span>))</span><br><span class="line">s.add(And(res2 &gt;= <span class="number">48</span>,res2 &lt;= <span class="number">57</span>))</span><br><span class="line">s.add(And(res3 &gt;= <span class="number">48</span>,res3 &lt;= <span class="number">57</span>))</span><br><span class="line"></span><br><span class="line">got = (res1-<span class="number">48</span>)*<span class="number">100</span> + (res2-<span class="number">48</span>)*<span class="number">10</span> + (res3-<span class="number">48</span>)</span><br><span class="line"><span class="comment">#got can be : 191, 465, 739</span></span><br><span class="line"></span><br><span class="line">s.add(got == <span class="number">191</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> s.check()</span><br><span class="line"><span class="built_in">print</span> s.model()</span><br><span class="line"><span class="comment"># Multiple solutions possible</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">while s.check() == sat:</span></span><br><span class="line"><span class="string">	solution = s.model()</span></span><br><span class="line"><span class="string">	block = []</span></span><br><span class="line"><span class="string">	c = inp</span></span><br><span class="line"><span class="string">	print solution[c] </span></span><br><span class="line"><span class="string">	block.append(c != solution[c])</span></span><br><span class="line"><span class="string">	s.add(Or(block))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>But indeed it validated successfully !!  </p>
<p><a href="/img/noverify/solved.PNG"><a href="/img/noverify/solved.PNG" title="solved" class="gallery-item"><img src="/img/noverify/solved.PNG" alt="solved"></a></a>  </p>
<a target="_blank" rel="noopener" href="https://media.giphy.com/media/kHmBzIxx4LRSM/giphy.gif" title="drawing" class="gallery-item"><img src="https://media.giphy.com/media/kHmBzIxx4LRSM/giphy.gif" alt="drawing" width="300"/></a>  

<hr>
<h1 id="Dynamic-Analysis"><a href="#Dynamic-Analysis" class="headerlink" title="Dynamic Analysis"></a>Dynamic Analysis</h1><p><strong><em>So, what did I miss?</em></strong> </p>
<p>I wanted to check what was going under the hood and tried some debuggers like jdb(didn’t work).<br>Also I came across <a target="_blank" rel="noopener" href="http://drgarbagetools.sourceforge.net/">Dr Garbage Tool’s</a> Bytecode Visualizer.<br>This is an old eclipse plugin set and doesn’t work with newer versions of eclipse.  </p>
<p>I was able to install it but alas I don’t know why it wasn’t able to identify the main method.<br><a href="/img/noverify/bytecode_visualizer_err.png" class="gallery-item"><img src="/img/noverify/bytecode_visualizer_err.png"></a>  </p>
<p>At last, I reached out for some java bytecode editors to add debug print statements.  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Col-E/Recaf">Recaf - A modern bytecode editor</a>  </li>
<li><a target="_blank" rel="noopener" href="https://github.com/GraxCode/JByteMod-Beta">JByteMod - Java bytecode editor</a>  </li>
</ul>
<p>Recaf is very easy to use and got a nice UI as well so I went with it.  </p>
<p>Also I asked Col-E(Recaf’s Developer) about any good bytecode debuggers and unfortunately, it turns out there aren’t any as of now!<br>I also shared the weirdness of this jar in extracting the class.  </p>
<p><a href="/img/noverify/jar_extract.PNG"><a href="/img/noverify/jar_extract.PNG" title="jar_extract" class="gallery-item"><img src="/img/noverify/jar_extract.PNG" alt="jar_extract"></a></a>  </p>
<p>And, Then I got to know about the forward slash trick which was pretty obvious from the jar verbose extraction that I didn’t observe carefully before.  </p>
<p><a href="/img/noverify/fwd_slash.PNG"><a href="/img/noverify/fwd_slash.PNG" title="fwd_slash" class="gallery-item"><img src="/img/noverify/fwd_slash.PNG" alt="fwd_slash"></a></a>  </p>
<p>Obviously the decompiler view doesn’t work so we’d have to switch to the class table mode.  </p>
<p><a href="/img/noverify/class_mode.PNG"><a href="/img/noverify/class_mode.PNG" title="class_mode" class="gallery-item"><img src="/img/noverify/class_mode.PNG" alt="class_mode"></a></a>  </p>
<p>Select method_0 and edit with assembler.  </p>
<p><a href="/img/noverify/edit_assembler.PNG"><a href="/img/noverify/edit_assembler.PNG" title="edit_assembler" class="gallery-item"><img src="/img/noverify/edit_assembler.PNG" alt="edit_assembler"></a></a>  </p>
<p>We can just add a <code>System.out.println()</code> for variable null1 shown.  </p>
<p><a href="/img/noverify/edit_0.PNG"><a href="/img/noverify/edit_0.PNG" title="edit_0" class="gallery-item"><img src="/img/noverify/edit_0.PNG" alt="edit_0"></a></a>  </p>
<p>If everything goes well, we should see this output.  </p>
<p><a href="/img/noverify/edited_0_output.PNG"><a href="/img/noverify/edited_0_output.PNG" title="edited_0_output" class="gallery-item"><img src="/img/noverify/edited_0_output.PNG" alt="edited_0_output"></a></a>  </p>
<p>We can do the same for the fun variable.<br>But we need some automation for adding these instructions in every method.<br>And currently Recaf doesn’t have any <a target="_blank" rel="noopener" href="https://github.com/Col-E/Recaf/issues/151">Automation API</a>.<br>So to resolve this problem I turned to dynamic instrumentation.  </p>
<h2 id="Dynamic-Instrumentation-using-ASM"><a href="#Dynamic-Instrumentation-using-ASM" class="headerlink" title="Dynamic Instrumentation using ASM"></a>Dynamic Instrumentation using ASM</h2><p>Just FYI I’m new to the instrumentation part so I checked out some frameworks/libraries which could help me with it.<br>As it turns out there are several options and I tried some of them such as <a target="_blank" rel="noopener" href="http://www.javassist.org/">JavaAssist</a>, <a target="_blank" rel="noopener" href="https://bytebuddy.net/">ByteBuddy</a> and <a target="_blank" rel="noopener" href="https://asm.ow2.io/">ASM</a>.<br>But ASM is at the lowest level and is the base for Bytebuddy and <a target="_blank" rel="noopener" href="https://github.com/cglib/cglib">cglib</a> as well, so I went with it!  </p>
<p>Checkout this stackoverflow answer for more on <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/45891652">Analysis of bytecode libraries</a></p>
<p><strong>ASM User Guide and Tutorials</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://asm.ow2.io/asm4-guide.pdf">https://asm.ow2.io/asm4-guide.pdf</a>  </li>
<li><a target="_blank" rel="noopener" href="http://www.egtry.com/java/bytecode/asm/">http://www.egtry.com/java/bytecode/asm/</a>  </li>
<li><a target="_blank" rel="noopener" href="https://www.tomsquest.com/blog/2014/01/intro-java-agent-and-bytecode-manipulation/">https://www.tomsquest.com/blog/2014/01/intro-java-agent-and-bytecode-manipulation/</a>  </li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/tagged/java-bytecode-asm">https://stackoverflow.com/questions/tagged/java-bytecode-asm</a></li>
</ul>
<p>For verifying your ASM Implementation and how ASM reads your class you can checkout <a target="_blank" rel="noopener" href="https://github.com/iridescent995/ASM_bytecode_manipulation/tree/master/ASMifier">ASMifier</a>.  </p>
<p>Here we have <code>v5</code> as <code>var_1</code> and the following condition adds these three lines of code after it encounters any <code>(ISTORE, 1)</code> instruction.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (opcode == ISTORE &amp;&amp; <span class="keyword">var</span> == <span class="number">1</span>) &#123;</span><br><span class="line">    mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">    mv.visitVarInsn(ILOAD, <span class="number">1</span>);</span><br><span class="line">    mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Same goes for logging the static variable ie. <code>fun</code>.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(opcode == PUTSTATIC &amp;&amp; name.equals(<span class="string">&quot;fun&quot;</span>)) &#123;</span><br><span class="line">    mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;java/lang/System&quot;</span>, <span class="string">&quot;out&quot;</span>, <span class="string">&quot;Ljava/io/PrintStream;&quot;</span>);</span><br><span class="line">    mv.visitFieldInsn(GETSTATIC, <span class="string">&quot;me/nov/crackme/CrackMe&quot;</span>, <span class="string">&quot;fun&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line">    mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">&quot;java/io/PrintStream&quot;</span>, <span class="string">&quot;println&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>I added a string ie. <code>CrackMe.fun =</code> to differentiate both of them. </p>
<p><a href="/img/noverify/agent_1.PNG"><a href="/img/noverify/agent_1.PNG" title="agent_1" class="gallery-item"><img src="/img/noverify/agent_1.PNG" alt="agent_1"></a></a>  </p>
<p>Cool lets see how it ends.   </p>
<p><a href="/img/noverify/agent_2.PNG"><a href="/img/noverify/agent_2.PNG" title="agent_2" class="gallery-item"><img src="/img/noverify/agent_2.PNG" alt="agent_2"></a></a>  </p>
<p><strong>Weirdness of method_63</strong></p>
<p>Ahh as you can see, I missed the most important part of this crackme, ie. UTF-8 LOL !<br>So single surrogates are illegal and are converted to <strong>‘ ? ‘</strong> character (ie. 63).<br>FYI Surrogates are characters in the Unicode range U+D800 - U+DFFF.<br>And Here we notice 56575 which is then converted to 63.  </p>
<p>Here it inverts the comparision sign and validates if the length of stacktrace is less than 127.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Thread.currentThread().getStackTrace().length &lt; <span class="number">0x7F</span>)</span><br></pre></td></tr></table></figure>
<p>So the stacktrace length check for other methods is bogus and is only used for deception.  </p>
<p>Also the v5 in method_63 always results in 127 which returns true halting the program.  </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(( get_hashcode(callee_fcn) * arg) * <span class="number">0x7FFF</span> &lt;&lt; <span class="number">3</span> | <span class="number">127</span>) &amp; <span class="number">127</span></span><br></pre></td></tr></table></figure>
<p>So now we know what were we missing.  </p>
<hr>
<h1 id="Solution-and-Source-files"><a href="#Solution-and-Source-files" class="headerlink" title="Solution and Source files"></a>Solution and Source files</h1><blockquote>
<p>I’ve uploaded all of my solution files along with the ASM Agent project for this crackme on my github.<br><a target="_blank" rel="noopener" href="https://github.com/mrT4ntr4/Challenge-Solution-Files/tree/master/noverify_crackme_3">mrT4ntr4/Challenge-Solution-Files/noverify_crackme_3</a></p>
</blockquote>
<p>Also krakatau does a good job that I got to know about from the author.<br>Also some of the source files were disclosed by him:  </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://hastebin.com/bacuwijuwe">Original Driver Source code</a></li>
<li><a target="_blank" rel="noopener" href="https://hastebin.com/cexomojesu">Keygen for methods</a></li>
<li><a target="_blank" rel="noopener" href="https://hastebin.com/rujanapeso">Final Keygen</a></li>
<li><a target="_blank" rel="noopener" href="https://hastebin.com/retilapila">Original ASMifier source code for final crackme</a></li>
</ul>
<p>And, some manual obfuscation was done afterwards.  </p>
<p>I enjoyed this challenge, all thanks to <a target="_blank" rel="noopener" href="https://twitter.com/graxcoding">@graxcoding</a> for making it!  </p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#TLDR"><span class="toc-number">1.</span> <span class="toc-text">TLDR</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge"><span class="toc-number">1.1.</span> <span class="toc-text">Challenge</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Static-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Static Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Indy-in-Action"><span class="toc-number">3.1.</span> <span class="toc-text">Indy in Action</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Algorithm"><span class="toc-number">3.2.</span> <span class="toc-text">Algorithm</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Dynamic-Analysis"><span class="toc-number">4.</span> <span class="toc-text">Dynamic Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Dynamic-Instrumentation-using-ASM"><span class="toc-number">4.1.</span> <span class="toc-text">Dynamic Instrumentation using ASM</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Solution-and-Source-files"><span class="toc-number">5.</span> <span class="toc-text">Solution and Source files</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&text=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&is_video=false&description=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3&body=Check out this article: https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&title=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&name=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://mrt4ntr4.github.io/Noverify-Java-Crackme-3/&t=Solving Java Reversing Challenges - Noverify&#39;s Crackme 3"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021
    Suraj Malhotra
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"CTRL+C\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
      setTimeout(function() {
        e.trigger.setAttribute('aria-label', "CTRL+C");
      }, 2000);
    })
  })
  </script>


<script src="/js/main.js"></script>





    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-132815766-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-132815766-1');
    </script>








</body>
</html>
