<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="article">
<meta property="og:title" content="UTC-CTF &#39;19 Teaser [Stacks-RE]">
<meta property="og:url" content="https://mrt4ntr4.github.io/UTC-Teaser-Stacks/index.html">
<meta property="og:site_name" content="mrT4ntr4&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/banner.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/stackthumb.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/samplerun.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/gdb1.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/strace.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/ptrace.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/gdb2.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/register1.jpg">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/data.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/algo1.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/algo4.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/algo2.png">
<meta property="og:image" content="https://mrt4ntr4.github.io/img/utc-teaser/algo3.png">
<meta property="og:image" content="https://media.giphy.com/media/g7X5T9PuUBAzu/giphy.gif">
<meta property="article:published_time" content="2019-12-22T07:00:00.000Z">
<meta property="article:modified_time" content="2021-05-20T21:24:17.025Z">
<meta property="article:author" content="Suraj Malhotra">
<meta property="article:tag" content="writeup">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="reversing">
<meta property="article:tag" content="utc">
<meta property="article:tag" content="radare">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mrt4ntr4.github.io/img/utc-teaser/banner.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.png">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
        
      
    
    <!-- title -->
    <title>UTC-CTF &#39;19 Teaser [Stacks-RE]</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
      <link rel="alternate" href="/feed.xml" title="mrT4ntr4&#39;s Blog" type="application/atom+xml" />
    
<meta name="generator" content="Hexo 5.3.0"></head>

<div class="background">
    <div class="banner">
<div id="blogtitle" class="blogtitle">mrT4ntr4&#39;s Blog</div>
<ul id="wrapper" class="wrapper">
  <div class="sun">
    <div class="star"></div>
  </div>
  <div class="mercury">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="venus">
    <div class="planet">
      <div class="shadow"></div>
    </div>
  </div>
  <div class="earth">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="mars">
    <div class="planet"><div class="shadow"></div></div>
  </div>
  <div class="jupiter">
    <div class="planet"><div class="shadow"></div></div>
  </div>
</ul>
</div>

    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/Nullcon-HackIM-Year3000/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/Cryptix-CTF-Crackit/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&text=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&is_video=false&description=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=UTC-CTF &#39;19 Teaser [Stacks-RE]&body=Check out this article: https://mrt4ntr4.github.io/UTC-Teaser-Stacks/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&name=UTC-CTF &#39;19 Teaser [Stacks-RE]&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&t=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TLDR"><span class="toc-number">1.1.</span> <span class="toc-text">TLDR;</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Challenge"><span class="toc-number">2.</span> <span class="toc-text">Challenge</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Initial-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Initial Analysis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#In-Depth-Debugging-based-Analysis"><span class="toc-number">4.</span> <span class="toc-text">In-Depth Debugging based Analysis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Automation-with-r2pipe"><span class="toc-number">5.</span> <span class="toc-text">Automation with r2pipe</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        UTC-CTF &#39;19 Teaser [Stacks-RE]
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Suraj Malhotra</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-12-22T07:00:00.000Z" itemprop="datePublished">2019-12-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF-Writeups/">CTF Writeups</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/ctf/" rel="tag">ctf</a>, <a class="tag-link-link" href="/tags/radare/" rel="tag">radare</a>, <a class="tag-link-link" href="/tags/reversing/" rel="tag">reversing</a>, <a class="tag-link-link" href="/tags/utc/" rel="tag">utc</a>, <a class="tag-link-link" href="/tags/writeup/" rel="tag">writeup</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"<p><a href="/img/utc-teaser/banner.png" title="banner" class="gallery-item"><img src="/img/utc-teaser/banner.png" alt="banner"></a></p>
<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>So Here I’m, finally writing after 2 months :)<br>I’ve been a bit busy in October and November and I did participate in 2 onsite CTF competetitions.  </p>
<ul>
<li><a href="https://csaw.engineering.nyu.edu/ctf" target="_blank">CSAW ‘19 CTF Finals</a></li>
<li><a href="https://www.dsci.in/content/hackathon-2019" target="_blank">DSCI ‘19 Hackathon Finals</a></li>
</ul>
<p>We didn’t win but had an awesome experience and made new friends.<br>But most of the time in November I was studying for my mid sem. :(  </p>
<p>Also my Team Dc1ph3R is organizing an international 20 hr Online Jeopardy Style CTF for the first time and so obviously I spent some time creating challenges for it too.<br>Its named as Inferno CTF and we’ll be giving away pentesterlab pro sub to the winners.<br>More details about it <a href="https://ctftime.org/event/951"  target="_blank">here</a>.<br>Go check it out!!   </p>
<p>I participated in many other CTFs in this period but I didn’t solve any challenge which was interesting and also worth sharing with you guys.  </p>
<hr>
<h2 id="TLDR"><a href="#TLDR" class="headerlink" title="TLDR;"></a>TLDR;</h2><p>Me and my friend participated in UTC-CTF ‘19 Teaser and secured the 10th rank. This post will be a detailed writeup depicting my method of solving the problem <em>stack</em> from Reversing category. FYI I did not solve it during the CTF. This crackme is a perfect example of how one can use a debugger script to automate tedious tasks. The crackme is stripped and has ptrace as an anti-debug check. We input a flag and it is being checked using some mathematical operations such as xor. Here I have used radare’s r2pipe to write a python script. </p>
<h1 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h1><p><a href="/img/utc-teaser/stackthumb.png" class="gallery-item"><img src="/img/utc-teaser/stackthumb.png"></a>  </p>
<blockquote>
<p>Download <a href="/files/utc-teaser/stack"  target="_blank">stack</a>  </p>
</blockquote>
<hr>
<h1 id="Initial-Analysis"><a href="#Initial-Analysis" class="headerlink" title="Initial Analysis"></a>Initial Analysis</h1><figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped</span><br></pre></td></tr></table></figure>
<p>Ahh the binary is stripped :(  </p>
<p>Lets run it.  </p>
<p><a href="/img/utc-teaser/samplerun.png" class="gallery-item"><img src="/img/utc-teaser/samplerun.png"></a>  </p>
<p>Lets take a look at what gdb has to offer..  </p>
<p><a href="/img/utc-teaser/gdb1.png" class="gallery-item"><img src="/img/utc-teaser/gdb1.png"></a>  </p>
<p>Ohh wait, Obviously we know that we’ll not get any symbols but the binary is not even running so there might be an anti-debug check.<br>A quick check with strace reveals the ptrace call.  </p>
<p><a href="/img/utc-teaser/strace.png" class="gallery-item"><img src="/img/utc-teaser/strace.png"></a>  </p>
<p>Ptrace detected!!  </p>
<p>So yeah it’ll be easy for us if we patch the ptrace call in order to explore further.<br>I then moved over to IDA.<br><strong>PS:</strong> I’m using IDAv7.4 Demo<br>Switch to the Text View to get some info.<br>I found the location of ptrace syscall as IDA identifies it.  </p>
<p><a href="/img/utc-teaser/ptrace.png" class="gallery-item"><img src="/img/utc-teaser/ptrace.png"></a>  </p>
<p><strong>RBX</strong> Register is being compared after the call as follows:  </p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x40111F</span>  <span class="keyword">syscall</span>   <span class="comment">; LINUX - sys_ptrace</span></span><br><span class="line"><span class="number">0x401121</span>  <span class="keyword">mov</span>       <span class="built_in">rbx</span>, <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"><span class="number">0x401128</span>  <span class="keyword">cmp</span>       <span class="built_in">rax</span>, <span class="built_in">rbx</span></span><br><span class="line"><span class="number">0x40112B</span>  <span class="keyword">jnz</span>       short loc_40112F</span><br><span class="line"><span class="number">0x40112D</span>  <span class="keyword">jmp</span>       short loc_4010EF <span class="comment">; exit()</span></span><br></pre></td></tr></table></figure>
<p>We can successfully bypass the ptrace anti-debug check by replacing the following instruction with a NOP, so that cmp does not return 0 as both <strong>RAX</strong>, <strong>RBX</strong> will remain 0 and condition will be True.  </p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:000401121    mov rbx, 0FFFFFFFFFFFFFFFFh</span><br></pre></td></tr></table></figure>
<p>I tried out Ghidra for patching too but idk why it doesn’t work for me and I get a segfault for every exported binary.<br>If someone found a workaround to fix it, please lmk in the comments. </p>
<p>Finally I patched the binary with pwntools.  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">elf = ELF(<span class="string">&#x27;./stack&#x27;</span>)</span><br><span class="line">elf.asm(<span class="number">0x401121</span>,<span class="string">&#x27;nop&#x27;</span>)</span><br><span class="line">elf.save(<span class="string">&#x27;./stack_patched&#x27;</span>)</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="In-Depth-Debugging-based-Analysis"><a href="#In-Depth-Debugging-based-Analysis" class="headerlink" title="In-Depth Debugging based Analysis"></a>In-Depth Debugging based Analysis</h1><p>Now we can easily load our patched binary in GDB.<br>It’ll be easy to follow along if you have GDB-Peda installed.  </p>
<p>run the binary in gdb and press CTRL+C when it asks for input.<br>and then step over and now enter a fake flag.<br>So now, <strong>RAX</strong> contains 0xa ie. len of our input including the null char.  </p>
<p><a href="/img/utc-teaser/gdb2.png" class="gallery-item"><img src="/img/utc-teaser/gdb2.png"></a>    </p>
<p>After stepping over some more instructions you’ll notice that our fake flag’s first character ie. <strong>‘u’</strong> hex value (0x75) has been moved into <strong>RBX</strong>‘s higher half ie. <strong>BH</strong> register<br>Here we have 32 bit registers so they are as follows:  </p>
<p><a href="/img/utc-teaser/register1.jpg" class="gallery-item"><img src="/img/utc-teaser/register1.jpg"></a>   </p>
<p>More about them <a href="https://www.tutorialspoint.com/assembly_programming/assembly_registers.htm"  target="_blank">here</a>.  </p>
<p>We also observe some hexdata in <strong>RSI</strong> which is being referenced from just below the Incorrect text.<br>This remains same for any input though.   </p>
<p><a href="/img/utc-teaser/data.png" class="gallery-item"><img src="/img/utc-teaser/data.png"></a>    </p>
<p>So the first byte from this data offset ie. 0x4f will move into <strong>AH</strong> (<strong>RAX</strong>‘s higher half)<br>The algorithm is depicted by the following assembly code.<br><a href="/img/utc-teaser/algo1.png" class="gallery-item"><img src="/img/utc-teaser/algo1.png"></a>    </p>
<p>At last it is xoring <strong>BH</strong> and <strong>DH</strong>, then storing the result in <strong>BH</strong>. But how do we get <strong>DH</strong> register value.. that’s the whole point here.<br>As <strong>ECX</strong> is mostly used as a counter register it is changing values everytime and also its value is dependent on <strong>R10</strong> at some point ie. in <strong>sub_401132</strong>.  </p>
<p><a href="/img/utc-teaser/algo4.png" class="gallery-item"><img src="/img/utc-teaser/algo4.png"></a>   </p>
<p>Moving further, <strong>BH</strong> and <strong>AH</strong> are subtracted.  </p>
<p><a href="/img/utc-teaser/algo2.png" class="gallery-item"><img src="/img/utc-teaser/algo2.png"></a>    </p>
<p>And if result comes out to be 0 then it is fine else it’ll exit which is stated by assembly code at <strong>loc_4010CC</strong>.  </p>
<p><a href="/img/utc-teaser/algo3.png" class="gallery-item"><img src="/img/utc-teaser/algo3.png"></a>   </p>
<p>So if we know <strong>AH</strong> and <strong>DH</strong> values, we can xor them and get characters for our flag but <strong>DH</strong> is not easy to find.  </p>
<p>Keep on stepping and notice the values of the register especially <strong>RCX</strong> as <strong>DH</strong> is dependent on it.<br>I made some notes and this was how it iterates over our input flag.</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-------0-------</span><br><span class="line">RCX: 0x4020f0 --&gt; 0x3a (&#x27;:&#x27;) (for flag[0])</span><br><span class="line">RDX: 0x403a32 (DH=0x3a)</span><br><span class="line">AH =  0x4f</span><br><span class="line">Check if (flag[0] ^ DH == AH)</span><br><span class="line">RCX: hex(0x4020f0 + 8*4)</span><br><span class="line">R10: value at RCX</span><br><span class="line">RCX += R10</span><br><span class="line"></span><br><span class="line">So flag[0] = chr( AH ^ DH)</span><br><span class="line">           = chr(0x4f ^0x3a)</span><br><span class="line">           = &#x27;u&#x27;</span><br><span class="line">-------1-------</span><br><span class="line">RCX: 0x40215f --&gt; 0x16 (for flag[1])</span><br><span class="line">RDX: 0x401632 (DH=0x16)</span><br><span class="line">AH = 0x62</span><br><span class="line">Check if (flag[1] ^ DH == AH)</span><br><span class="line">RCX += hex( 0x40215f + 8*4)</span><br><span class="line">R10: value at RCX</span><br><span class="line">RCX += R10</span><br><span class="line"></span><br><span class="line">So flag[1] = chr( AH ^ DH)</span><br><span class="line">           = chr(0x62 ^0x16)</span><br><span class="line">           = &#x27;t&#x27;</span><br></pre></td></tr></table></figure>
<p>But as the no. of solves kept increasing, I decided to ditch this tedious approach (or maybe it was wrong here) and thought of automating the debugging process to get <strong>DH</strong> value.</p>
<h1 id="Automation-with-r2pipe"><a href="#Automation-with-r2pipe" class="headerlink" title="Automation with r2pipe"></a>Automation with r2pipe</h1><p>I chose radare r2pipe to write a short python script which sets a breakpoint just after xoring <strong>BH</strong> &amp; <strong>DH</strong>.<br>With this method I was able to get AH and DH value and at the same time I used a little trick which helped me not to provide stdin everytime it fails.</p>
<p>Here I set BH = AH, after I get AH value in each iteration and the subtraction returns 0 everytime. Therefore, there is no case of failure :)</p>
<p>Resources: <a href="https://r2wiki.readthedocs.io/en/latest/home/radare2-python-scripting/"  target="_blank">r2pipe docs</a>  </p>
<p><strong>PS:</strong> Create a file named <em>“stack_patched.rr2”</em> which is just used to assist in not breaking the script when it asks for input.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/rarun2</span></span><br><span class="line">program=./stack_patched</span><br><span class="line">stdin=<span class="string">&quot;&quot;</span></span><br><span class="line">stdout=</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> r2pipe</span><br><span class="line">r = r2pipe.<span class="built_in">open</span>(<span class="string">&#x27;stack_patched&#x27;</span>,flags=[<span class="string">&#x27;-2&#x27;</span>])</span><br><span class="line">bp = <span class="number">0x40103a</span>   <span class="comment"># after &quot;xor bh, dh&quot;</span></span><br><span class="line">r.cmd(<span class="string">&#x27;e dbg.profile=stack_patched.rr2&#x27;</span>)</span><br><span class="line">flag=<span class="string">&quot;&quot;</span></span><br><span class="line">r.cmd(<span class="string">&#x27;doo&#x27;</span>)</span><br><span class="line">r.cmd(<span class="string">&#x27;db &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(bp))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>):</span><br><span class="line">  r.cmd(<span class="string">&#x27;dc&#x27;</span>)</span><br><span class="line">  ah = r.cmd(<span class="string">&#x27;dr ah&#x27;</span>)</span><br><span class="line">  dh = r.cmd(<span class="string">&#x27;dr dh&#x27;</span>)</span><br><span class="line">  next_char = <span class="built_in">chr</span>(<span class="built_in">int</span>(ah,<span class="number">16</span>)^<span class="built_in">int</span>(dh,<span class="number">16</span>))</span><br><span class="line">  flag += next_char</span><br><span class="line">  <span class="built_in">print</span> <span class="string">&#x27;[&#123;&#125;] &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i,flag)</span><br><span class="line">  r.cmd(<span class="string">&#x27;dr bh=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(ah))</span><br></pre></td></tr></table></figure>
<p>This script yeilds our flag!!</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">utc&#123;stAcks_Ar3_WACK!!!_HEHEXDXD&#125;</span><br></pre></td></tr></table></figure>
<p>And B00mYa we earned it !! </p>
<a target="_blank" rel="noopener" href="https://media.giphy.com/media/g7X5T9PuUBAzu/giphy.gif" title="drawing" class="gallery-item"><img src="https://media.giphy.com/media/g7X5T9PuUBAzu/giphy.gif" alt="drawing" width="300"/></a>  


<p>Also the challenge source was disclosed by the admins on github.  </p>
<blockquote>
<p>Github Source <a href="https://github.com/utcoalition/utcctf-19/tree/master/rev-stacks"  target="_blank">rev-stacks</a></p>
</blockquote>
<p>See yall in next writeup</p>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TLDR"><span class="toc-number">1.1.</span> <span class="toc-text">TLDR;</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Challenge"><span class="toc-number">2.</span> <span class="toc-text">Challenge</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Initial-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Initial Analysis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#In-Depth-Debugging-based-Analysis"><span class="toc-number">4.</span> <span class="toc-text">In-Depth Debugging based Analysis</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Automation-with-r2pipe"><span class="toc-number">5.</span> <span class="toc-text">Automation with r2pipe</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&text=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&is_video=false&description=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=UTC-CTF &#39;19 Teaser [Stacks-RE]&body=Check out this article: https://mrt4ntr4.github.io/UTC-Teaser-Stacks/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&title=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&name=UTC-CTF &#39;19 Teaser [Stacks-RE]&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://mrt4ntr4.github.io/UTC-Teaser-Stacks/&t=UTC-CTF &#39;19 Teaser [Stacks-RE]"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2023
    Suraj Malhotra
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"CTRL+C\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
      setTimeout(function() {
        e.trigger.setAttribute('aria-label', "CTRL+C");
      }, 2000);
    })
  })
  </script>


<script src="/js/main.js"></script>





    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-132815766-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-132815766-1');
    </script>








</body>
</html>
